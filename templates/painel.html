
{% extends "base.html" %}

{% block title %}Painel - DarkFov{% endblock %}

{% block content %}
<section class="dashboard-section">
    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="user-welcome">
                <div class="welcome-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="welcome-info">
                    <h1>Bem-vindo ao <span class="highlight">DarkFov</span></h1>
                    <span class="user-email" id="userEmail">carregando...</span>
                    <span class="user-since">Membro desde <span id="userSince">2024</span></span>
                </div>
            </div>
            <div class="dashboard-actions">
                <button class="btn btn-outline" onclick="checkLicenseStatus()">
                    <i class="fas fa-sync-alt"></i>
                    Atualizar Status
                </button>
            </div>
        </div>

        <!-- Success Message -->
        <div id="successMessage" class="success-message" style="display: none;">
            <i class="fas fa-check-circle"></i>
            <span>Operação realizada com sucesso!</span>
        </div>

        <!-- Dashboard Grid -->
        <div class="panel-grid">
            <!-- STATUS DA LICENÇA -->
            <div class="panel-card status-card">
                <div class="panel-header">
                    <h2><i class="fas fa-key"></i> STATUS DA LICENÇA</h2>
                    <div class="header-icon">
                        <i class="fas fa-pen"></i>
                    </div>
                </div>
                <div class="panel-content">
                    <div id="licenseStatusIcon" class="status-icon-container">
                        <i class="fas fa-shield-alt status-icon status-warning"></i>
                        <span class="status-text" id="licenseStatusText">Sem Licença Ativa</span>
                    </div>
                    <p class="status-description" id="licenseDescription">Adquira uma licença para acessar o DarkFov Aimbot</p>
                    <button class="panel-button" id="licenseButton" onclick="window.location.href='/comprar'">
                        CONSEGUIR LICENÇA
                    </button>

                    <!-- Detalhes da licença ativa (oculto inicialmente) -->
                    <div id="licenseActiveDetails" style="display: none;">
                        <div class="license-details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Expira em:</span>
                                <span class="detail-value" id="expirationDate">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Dias restantes:</span>
                                <span class="detail-value" id="daysRemaining">-</span>
                            </div>
                        </div>
                        <button class="panel-button renew-button" id="renewButton" onclick="window.location.href='/comprar'" style="display: none;">
                            RENOVAR LICENÇA
                        </button>
                    </div>
                </div>
            </div>

            <!-- DOWNLOAD -->
            <div class="panel-card download-card">
                <div class="panel-header">
                    <h2><i class="fas fa-download"></i> DOWNLOAD</h2>
                    <div class="header-icon">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="download-section" id="downloadAvailable" style="display: none;">
                        <p class="download-description">Download disponível apenas para usuários com licença ativa</p>
                        <button class="panel-button" onclick="downloadLoader()">
                            DOWNLOAD LOADER
                        </button>
                    </div>
                    
                    <div class="download-locked-section" id="downloadLocked">
                        <div class="locked-icon">
                            <i class="fas fa-lock"></i>
                        </div>
                        <p class="locked-description">Download disponível apenas para usuários com licença ativa</p>
                        <button class="panel-button disabled" disabled>
                            ADQUIRIR LICENÇA
                        </button>
                    </div>
                </div>
            </div>

            <!-- COMO USAR -->
            <div class="panel-card usage-card">
                <div class="panel-header">
                    <h2><i class="fas fa-question-circle"></i> COMO USAR</h2>
                    <div class="header-icon">
                        <i class="fas fa-info"></i>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="usage-steps">
                        <div class="usage-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>DOWNLOAD</h4>
                                <p>Baixe o loader DarkFov</p>
                            </div>
                        </div>
                        <div class="usage-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>EXECUÇÃO</h4>
                                <p>Execute como administrador</p>
                            </div>
                        </div>
                        <div class="usage-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>CONFIGURAÇÃO</h4>
                                <p>Ajuste conforme necessário</p>
                            </div>
                        </div>
                        <div class="usage-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4>JOGO</h4>
                                <p>Inicie o BloodStrike</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SUPORTE -->
            <div class="panel-card support-card">
                <div class="panel-header">
                    <h2><i class="fas fa-headset"></i> SUPORTE</h2>
                    <div class="header-icon">
                        <i class="fas fa-life-ring"></i>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="support-options">
                        <div class="support-option discord">
                            <div class="support-icon">
                                <i class="fab fa-discord"></i>
                            </div>
                            <div class="support-info">
                                <h4>DISCORD</h4>
                                <p>Suporte em tempo real</p>
                            </div>
                            <button class="support-button">ACESSAR</button>
                        </div>
                        <div class="support-option telegram">
                            <div class="support-icon">
                                <i class="fab fa-telegram"></i>
                            </div>
                            <div class="support-info">
                                <h4>TELEGRAM</h4>
                                <p>Grupo exclusivo</p>
                            </div>
                            <button class="support-button">ACESSAR</button>
                        </div>
                        <div class="support-option email">
                            <div class="support-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="support-info">
                                <h4>EMAIL</h4>
                                <p>suporte@darkfov.com</p>
                            </div>
                            <button class="support-button">ACESSAR</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    checkAuthentication();
    loadUserData();
    checkLicenseStatus();

    // Verificar se há parâmetro de sucesso na URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('compra') === 'sucesso') {
        showSuccessMessage('Compra realizada com sucesso! Sua licença foi ativada.');
    }
});

function checkAuthentication() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login';
        return;
    }
}

function loadUserData() {
    const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
    if (userData.email) {
        document.getElementById('userEmail').textContent = userData.email;

        // Calcular data de criação aproximada
        const createdDate = userData.created_at ? new Date(userData.created_at) : new Date();
        document.getElementById('userSince').textContent = createdDate.getFullYear();
    }
}

async function checkLicenseStatus() {
    const token = localStorage.getItem('access_token');

    try {
        const response = await fetch('/api/license/check', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const data = await response.json();

        if (response.ok) {
            updateLicenseDisplay(data);
        } else {
            if (response.status === 401) {
                localStorage.clear();
                window.location.href = '/login';
            } else {
                showLicenseError();
            }
        }

    } catch (error) {
        console.error('Erro ao verificar licença:', error);
        showLicenseError();
    }
}

function updateLicenseDisplay(licenseData) {
    const statusIcon = document.querySelector('.status-icon');
    const statusText = document.getElementById('licenseStatusText');
    const statusDescription = document.getElementById('licenseDescription');
    const licenseButton = document.getElementById('licenseButton');
    const licenseActiveDetails = document.getElementById('licenseActiveDetails');
    const renewButton = document.getElementById('renewButton');
    const downloadAvailable = document.getElementById('downloadAvailable');
    const downloadLocked = document.getElementById('downloadLocked');

    if (licenseData.valid) {
        const expirationDate = new Date(licenseData.data_expiracao);
        const now = new Date();
        const daysRemaining = Math.ceil((expirationDate - now) / (1000 * 60 * 60 * 24));

        // Atualizar status
        statusIcon.className = 'fas fa-shield-alt status-icon status-active';
        statusText.textContent = 'Licença Ativa';
        statusDescription.textContent = 'Sua licença está ativa e funcionando perfeitamente';
        
        // Mostrar detalhes da licença
        licenseActiveDetails.style.display = 'block';
        document.getElementById('expirationDate').textContent = expirationDate.toLocaleDateString('pt-BR');
        document.getElementById('daysRemaining').textContent = daysRemaining + ' dias';

        // Verificar se precisa renovar
        if (daysRemaining <= 7) {
            statusIcon.className = 'fas fa-shield-alt status-icon status-warning';
            statusText.textContent = 'Licença Expirando';
            statusDescription.textContent = 'Sua licença expira em breve, renove agora';
            renewButton.style.display = 'block';
        } else {
            renewButton.style.display = 'none';
        }

        // Ocultar botão principal e mostrar downloads
        licenseButton.style.display = 'none';
        downloadAvailable.style.display = 'block';
        downloadLocked.style.display = 'none';

    } else {
        // Licença inativa
        statusIcon.className = 'fas fa-shield-alt status-icon status-warning';
        statusText.textContent = 'Sem Licença Ativa';
        statusDescription.textContent = 'Adquira uma licença para acessar o DarkFov Aimbot';
        
        licenseActiveDetails.style.display = 'none';
        licenseButton.style.display = 'block';
        downloadAvailable.style.display = 'none';
        downloadLocked.style.display = 'block';
    }
}

function showLicenseError() {
    const statusContainer = document.getElementById('licenseStatus');
    statusContainer.innerHTML = `
        <div class="status-error">
            <i class="fas fa-exclamation-triangle"></i>
            <span>ERRO DE CONEXÃO</span>
        </div>
    `;
}

function showSuccessMessage(message) {
    const successMsg = document.getElementById('successMessage');
    successMsg.querySelector('span').textContent = message;
    successMsg.style.display = 'flex';

    setTimeout(() => {
        successMsg.style.display = 'none';
    }, 5000);
}

function downloadLoader() {
    const loaderContent = `import tkinter as tk
from tkinter import messagebox, ttk
import requests
import subprocess
import os
import json
import webbrowser
from datetime import datetime
import threading

# Configurações
API_URL = "https://darkfov.repl.co"
LOGIN_URL = f"{API_URL}/api/login"
LICENSE_URL = f"{API_URL}/api/license/check"

class DarkFovLoader:
    def __init__(self):
        self.token = None
        self.setup_window()

    def setup_window(self):
        self.janela = tk.Tk()
        self.janela.title("DarkFov Loader v2.1")
        self.janela.geometry("450x350")
        self.janela.configure(bg="#0a0a0f")
        self.janela.resizable(False, False)
        
        # Centralizar janela
        self.janela.eval('tk::PlaceWindow . center')

        # Header
        header_frame = tk.Frame(self.janela, bg="#0a0a0f")
        header_frame.pack(pady=20)

        # Logo/Título
        tk.Label(header_frame, text="🎯 DarkFov", fg="#00fff7", bg="#0a0a0f", 
                font=("Orbitron", 28, "bold")).pack()
        
        tk.Label(header_frame, text="Aim Assist Premium", fg="#9D4EDD", bg="#0a0a0f", 
                font=("Arial", 12)).pack()

        # Login Frame
        login_frame = tk.Frame(self.janela, bg="#1a1a2e", relief="ridge", bd=2)
        login_frame.pack(pady=20, padx=40, fill="x")

        tk.Label(login_frame, text="LOGIN", fg="#00fff7", bg="#1a1a2e", 
                font=("Orbitron", 14, "bold")).pack(pady=(10, 5))

        # Email
        tk.Label(login_frame, text="Email:", bg="#1a1a2e", fg="#e0e0e0", 
                font=("Arial", 10)).pack(anchor="w", padx=20)
        self.entry_email = tk.Entry(login_frame, width=35, bg="#2a2a3e", fg="#e0e0e0", 
                                   font=("Arial", 10), relief="flat", bd=5)
        self.entry_email.pack(pady=(0, 10), padx=20)

        # Senha
        tk.Label(login_frame, text="Senha:", bg="#1a1a2e", fg="#e0e0e0", 
                font=("Arial", 10)).pack(anchor="w", padx=20)
        self.entry_senha = tk.Entry(login_frame, show="*", width=35, bg="#2a2a3e", 
                                   fg="#e0e0e0", font=("Arial", 10), relief="flat", bd=5)
        self.entry_senha.pack(pady=(0, 15), padx=20)

        # Botões
        btn_frame = tk.Frame(login_frame, bg="#1a1a2e")
        btn_frame.pack(pady=(0, 15))

        self.btn_login = tk.Button(btn_frame, text="ENTRAR", bg="#00fff7", fg="#000", 
                                  width=15, height=2, font=("Orbitron", 10, "bold"),
                                  command=self.login, relief="flat", cursor="hand2")
        self.btn_login.pack(side="left", padx=5)

        self.btn_register = tk.Button(btn_frame, text="REGISTRAR", bg="#9D4EDD", fg="#fff", 
                                     width=15, height=2, font=("Orbitron", 10, "bold"),
                                     command=self.open_register, relief="flat", cursor="hand2")
        self.btn_register.pack(side="left", padx=5)

        # Status
        self.status_label = tk.Label(self.janela, text="Pronto para conectar", 
                                    fg="#39FF14", bg="#0a0a0f", font=("Arial", 9))
        self.status_label.pack(pady=10)

        # Progress bar
        self.progress = ttk.Progressbar(self.janela, mode='indeterminate')
        
        # Bind Enter key
        self.janela.bind('<Return>', lambda e: self.login())

    def update_status(self, message, color="#39FF14"):
        self.status_label.config(text=message, fg=color)
        self.janela.update()

    def show_progress(self, show=True):
        if show:
            self.progress.pack(pady=5)
            self.progress.start()
        else:
            self.progress.stop()
            self.progress.pack_forget()

    def login(self):
        email = self.entry_email.get().strip()
        senha = self.entry_senha.get()

        if not email or not senha:
            messagebox.showwarning("Aviso", "Preencha todos os campos!")
            return

        self.btn_login.config(state="disabled")
        self.show_progress(True)
        self.update_status("Conectando...", "#00fff7")

        # Login em thread separada
        threading.Thread(target=self._do_login, args=(email, senha), daemon=True).start()

    def _do_login(self, email, senha):
        try:
            response = requests.post(LOGIN_URL, 
                                   data={"username": email, "password": senha},
                                   timeout=10)

            if response.status_code == 200:
                data = response.json()
                self.token = data.get("access_token")
                
                self.janela.after(0, lambda: self.update_status("Login realizado com sucesso!", "#39FF14"))
                self.janela.after(500, self.check_license)
                
            else:
                error_msg = "Credenciais inválidas"
                if response.status_code == 422:
                    error_msg = "Formato de dados inválido"
                
                self.janela.after(0, lambda: self.update_status(error_msg, "#FF3333"))
                self.janela.after(0, lambda: messagebox.showerror("Erro", error_msg))
                
        except requests.exceptions.Timeout:
            self.janela.after(0, lambda: self.update_status("Timeout - Tente novamente", "#FF3333"))
            self.janela.after(0, lambda: messagebox.showerror("Erro", "Conexão expirou"))
        except Exception as e:
            self.janela.after(0, lambda: self.update_status("Erro de conexão", "#FF3333"))
            self.janela.after(0, lambda: messagebox.showerror("Erro", f"Erro de conexão: {e}"))
        finally:
            self.janela.after(0, lambda: self.btn_login.config(state="normal"))
            self.janela.after(0, lambda: self.show_progress(False))

    def check_license(self):
        if not self.token:
            return

        self.update_status("Verificando licença...", "#00fff7")
        threading.Thread(target=self._do_license_check, daemon=True).start()

    def _do_license_check(self):
        try:
            headers = {"Authorization": f"Bearer {self.token}"}
            response = requests.get(LICENSE_URL, headers=headers, timeout=10)

            if response.status_code == 200:
                data = response.json()
                if data.get("valid"):
                    self.janela.after(0, lambda: self.show_license_info(data))
                else:
                    self.janela.after(0, lambda: self.update_status("Licença inválida ou expirada", "#FF3333"))
                    self.janela.after(0, lambda: messagebox.showwarning("Aviso", "Sua licença não está ativa!"))
            else:
                self.janela.after(0, lambda: self.update_status("Erro ao verificar licença", "#FF3333"))
                
        except Exception as e:
            self.janela.after(0, lambda: self.update_status("Erro na verificação", "#FF3333"))

    def show_license_info(self, license_data):
        from datetime import datetime
        
        exp_date = datetime.fromisoformat(license_data["data_expiracao"].replace('Z', '+00:00'))
        days_left = (exp_date - datetime.now()).days
        
        info = f"✅ Licença Ativa\\n"
        info += f"📅 Expira em: {exp_date.strftime('%d/%m/%Y')}\\n"
        info += f"⏰ Dias restantes: {days_left}"
        
        if days_left <= 7:
            info += "\\n⚠️ RENOVAÇÃO NECESSÁRIA EM BREVE!"
        
        messagebox.showinfo("Status da Licença", info)
        self.update_status(f"Licença válida - {days_left} dias restantes", "#39FF14")

    def open_register(self):
        webbrowser.open("https://darkfov.repl.co/register")

    def run(self):
        try:
            self.janela.mainloop()
        except KeyboardInterrupt:
            pass

if __name__ == "__main__":
    try:
        loader = DarkFovLoader()
        loader.run()
    except Exception as e:
        print(f"Erro: {e}")
        input("Pressione Enter para sair...")
`;

    const blob = new Blob([loaderContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = 'DarkFov_Loader_v2.1.py';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);

    showToast('Desktop Loader baixado com sucesso!', 'success');
}

function downloadManual() {
    const manualContent = `# DARKFOV - MANUAL COMPLETO DO USUÁRIO
Versão 2.1.0 | Atualizado em ${new Date().toLocaleDateString('pt-BR')}

## 📋 ÍNDICE
1. Instalação
2. Configuração Inicial
3. Uso do Software
4. Dicas Importantes
5. Solução de Problemas
6. Suporte

## 🚀 INSTALAÇÃO

### Pré-requisitos:
- Windows 10/11 (64-bit)
- Python 3.8+ (se usar versão .py)
- Conta ativa no DarkFov
- Licença válida

### Passos de Instalação:
1. Baixe o Desktop Loader do painel
2. Extraia o arquivo em uma pasta segura
3. Execute como administrador
4. Faça login com suas credenciais
5. Aguarde a verificação da licença

## ⚙️ CONFIGURAÇÃO INICIAL

### Primeira execução:
1. **Execute como Administrador**
   - Clique com botão direito no loader
   - Selecione "Executar como administrador"
   - Isso é OBRIGATÓRIO para funcionamento

2. **Configurar Antivírus**
   - Adicione o loader às exceções
   - Ou desative temporariamente durante o uso
   - Windows Defender pode bloquear o arquivo

3. **Verificar Firewall**
   - Permita o acesso do loader
   - Libere conexões de entrada e saída

## 🎮 USO DO SOFTWARE

### Iniciando o DarkFov:
1. Execute o loader como administrador
2. Faça login com email e senha
3. Aguarde verificação da licença
4. Abra o BloodStrike
5. O aimbot será carregado automaticamente

### Controles Principais:
- **F1**: Ativar/Desativar aimbot
- **F2**: Alternar modo de mira
- **F3**: Ajustar sensibilidade
- **F4**: Menu de configurações
- **ESC**: Fechar menu/sair

### Configurações Recomendadas:
- Sensibilidade: 50-70%
- Modo de mira: Automático
- Área de detecção: Médio
- Suavização: Ligada

## ⚠️ DICAS IMPORTANTES

### 🛡️ Execute sempre como administrador
- **Por que?** O software precisa de privilégios elevados
- **Como?** Botão direito → "Executar como administrador"
- **Sempre** faça isso, mesmo que pareça estar funcionando

### 🦠 Desative antivírus temporariamente
- **Windows Defender**: Pode bloquear o arquivo
- **Outros antivírus**: Adicionem à lista de exceções
- **Importante**: Reative após o uso

### 🌐 Use apenas em modo offline
- **Desconecte da internet** durante o uso
- **Evita detecção** pelos sistemas anti-cheat
- **Reconecte** apenas após fechar o jogo

### 🔄 Mantenha o loader sempre atualizado
- **Verifique atualizações** semanalmente
- **Baixe novas versões** do painel
- **Versões antigas** podem não funcionar

## 🔧 SOLUÇÃO DE PROBLEMAS

### Erro: "Licença não encontrada"
- Verifique se sua licença está ativa
- Faça login novamente
- Contate o suporte se persistir

### Erro: "Acesso negado"
- Execute como administrador
- Desative antivírus temporariamente
- Verifique permissões da pasta

### Aimbot não funciona no jogo
- Certifique-se que o BloodStrike está rodando
- Verifique se o loader foi executado primeiro
- Reinicie ambos os programas

### Jogo não abre
- Desative antivírus
- Execute como administrador
- Verifique se não há outros cheats rodando

### Conexão com servidor falha
- Verifique sua internet
- Tente em alguns minutos
- Contate suporte se persistir

## 📞 SUPORTE TÉCNICO

### Canais de Atendimento:
- **Discord**: Resposta em minutos
- **Telegram**: Suporte direto
- **Email**: suporte@darkfov.com

### Informações para o Suporte:
- Versão do loader
- Sistema operacional
- Descrição detalhada do problema
- Screenshots (se necessário)

### Horários de Atendimento:
- **Discord/Telegram**: 24/7
- **Email**: 24h para resposta
- **Suporte prioritário** para licenças ativas

## 🚨 AVISOS LEGAIS

### Responsabilidade:
- Use por sua conta e risco
- Não nos responsabilizamos por banimentos
- Leia os termos de uso completos

### Recomendações:
- Use apenas em contas secundárias
- Não abuse do software
- Seja discreto durante o uso

### Suporte:
- Suporte apenas para usuários com licença ativa
- Não fornecemos suporte para versões pirata
- Reporte bugs e problemas

---

© 2024 DarkFov. Todos os direitos reservados.
Para mais informações: https://darkfov.repl.co

## 📱 CONTATOS RÁPIDOS
- Site: https://darkfov.repl.co
- Discord: discord.gg/darkfov
- Telegram: @darkfov_support
- Email: suporte@darkfov.com
`;

    const blob = new Blob([manualContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = 'DarkFov_Manual_Completo.txt';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);

    showToast('Manual completo baixado!', 'success');
}
</script>
{% endblock %}
