{% extends "base.html" %}

{% block title %}Painel do Usuário - DarkFov{% endblock %}

{% block content %}
<section class="dashboard-section">
    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="user-welcome">
                <h1>PAINEL DE CONTROLE</h1>
                <p class="user-email">Bem-vindo, <span id="userEmail">carregando...</span></p>
            </div>
            <div class="dashboard-actions">
                <button class="btn btn-primary" onclick="downloadScript()">
                    <i class="fas fa-download"></i>
                    BAIXAR SCRIPT
                </button>
            </div>
        </div>
        
        <!-- License Status Card -->
        <div class="dashboard-grid">
            <div class="dashboard-card license-card">
                <div class="card-header">
                    <h3><i class="fas fa-shield-alt"></i> STATUS DA LICENÇA</h3>
                </div>
                <div class="card-body">
                    <div class="license-status" id="licenseStatus">
                        <div class="status-indicator status-loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Verificando...</span>
                        </div>
                    </div>
                    <div class="license-details" id="licenseDetails" style="display: none;">
                        <div class="detail-item">
                            <span class="label">Expira em:</span>
                            <span class="value" id="expirationDate">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Dias restantes:</span>
                            <span class="value" id="daysRemaining">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- System Status Card -->
            <div class="dashboard-card system-card">
                <div class="card-header">
                    <h3><i class="fas fa-desktop"></i> STATUS DO SISTEMA</h3>
                </div>
                <div class="card-body">
                    <div class="system-stats">
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-server"></i>
                            </div>
                            <div class="stat-info">
                                <span class="stat-label">Servidores</span>
                                <span class="stat-value status-online">ONLINE</span>
                            </div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="stat-info">
                                <span class="stat-label">Anti-Detecção</span>
                                <span class="stat-value status-active">ATIVO</span>
                            </div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-sync-alt"></i>
                            </div>
                            <div class="stat-info">
                                <span class="stat-label">Última Atualização</span>
                                <span class="stat-value">Hoje</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Download Section -->
            <div class="dashboard-card download-card">
                <div class="card-header">
                    <h3><i class="fas fa-download"></i> DOWNLOADS</h3>
                </div>
                <div class="card-body">
                    <div class="download-items">
                        <div class="download-item">
                            <div class="download-info">
                                <h4>FovDark Loader</h4>
                                <p>Aplicativo desktop para login e execução</p>
                            </div>
                            <button class="btn btn-outline btn-small" onclick="downloadLoader()">
                                <i class="fas fa-download"></i>
                                BAIXAR LOADER
                            </button>
                        </div>
                        
                        <div class="download-item">
                            <div class="download-info">
                                <h4>Manual de Uso</h4>
                                <p>Guia completo de configuração</p>
                            </div>
                            <button class="btn btn-outline btn-small" onclick="downloadManual()">
                                <i class="fas fa-book"></i>
                                BAIXAR MANUAL
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="dashboard-card actions-card">
                <div class="card-header">
                    <h3><i class="fas fa-bolt"></i> AÇÕES RÁPIDAS</h3>
                </div>
                <div class="card-body">
                    <div class="action-buttons">
                        <button class="action-btn" onclick="window.location.href='/comprar'">
                            <i class="fas fa-plus"></i>
                            <span>Renovar Licença</span>
                        </button>
                        
                        <button class="action-btn" onclick="openSupportModal()">
                            <i class="fas fa-headset"></i>
                            <span>Suporte</span>
                        </button>
                        
                        <button class="action-btn" onclick="openSettingsModal()">
                            <i class="fas fa-cog"></i>
                            <span>Configurações</span>
                        </button>
                        
                        <button class="action-btn" onclick="checkUpdates()">
                            <i class="fas fa-sync-alt"></i>
                            <span>Verificar Updates</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="dashboard-card activity-card">
                <div class="card-header">
                    <h3><i class="fas fa-history"></i> ATIVIDADE RECENTE</h3>
                </div>
                <div class="card-body">
                    <div class="activity-list" id="activityList">
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-sign-in-alt"></i>
                            </div>
                            <div class="activity-info">
                                <span class="activity-text">Login realizado</span>
                                <span class="activity-time">Agora</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Stats -->
            <div class="dashboard-card stats-card">
                <div class="card-header">
                    <h3><i class="fas fa-chart-line"></i> ESTATÍSTICAS</h3>
                </div>
                <div class="card-body">
                    <div class="performance-stats">
                        <div class="performance-item">
                            <span class="perf-label">Precisão Média</span>
                            <div class="perf-bar">
                                <div class="perf-fill" style="width: 95%"></div>
                            </div>
                            <span class="perf-value">95%</span>
                        </div>
                        
                        <div class="performance-item">
                            <span class="perf-label">Tempo de Resposta</span>
                            <div class="perf-bar">
                                <div class="perf-fill" style="width: 88%"></div>
                            </div>
                            <span class="perf-value">88ms</span>
                        </div>
                        
                        <div class="performance-item">
                            <span class="perf-label">Eficiência</span>
                            <div class="perf-bar">
                                <div class="perf-fill" style="width: 92%"></div>
                            </div>
                            <span class="perf-value">92%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Support Modal -->
<div id="supportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>SUPORTE TÉCNICO</h2>
            <button class="modal-close" onclick="closeModal('supportModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="support-options">
                <a href="#" class="support-option">
                    <i class="fab fa-discord"></i>
                    <div>
                        <h3>Discord</h3>
                        <p>Chat em tempo real com a comunidade</p>
                    </div>
                </a>
                
                <a href="#" class="support-option">
                    <i class="fab fa-telegram"></i>
                    <div>
                        <h3>Telegram</h3>
                        <p>Suporte direto via mensagens</p>
                    </div>
                </a>
                
                <a href="#" class="support-option">
                    <i class="fas fa-ticket-alt"></i>
                    <div>
                        <h3>Ticket</h3>
                        <p>Abrir chamado para problemas específicos</p>
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    checkAuthentication();
    loadUserData();
    checkLicenseStatus();
});

function checkAuthentication() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login';
        return;
    }
}

function loadUserData() {
    const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
    if (userData.email) {
        document.getElementById('userEmail').textContent = userData.email;
    }
}

async function checkLicenseStatus() {
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch('/api/license/check', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            updateLicenseDisplay(data);
        } else {
            if (response.status === 401) {
                localStorage.clear();
                window.location.href = '/login';
            } else {
                showLicenseError();
            }
        }
        
    } catch (error) {
        console.error('Erro ao verificar licença:', error);
        showLicenseError();
    }
}

function updateLicenseDisplay(licenseData) {
    const statusContainer = document.getElementById('licenseStatus');
    const detailsContainer = document.getElementById('licenseDetails');
    
    if (licenseData.valid) {
        const expirationDate = new Date(licenseData.data_expiracao);
        const now = new Date();
        const daysRemaining = Math.ceil((expirationDate - now) / (1000 * 60 * 60 * 24));
        
        let statusClass = 'status-active';
        let statusText = 'ATIVA';
        
        if (daysRemaining <= 3) {
            statusClass = 'status-warning';
            statusText = 'EXPIRANDO';
        } else if (daysRemaining <= 7) {
            statusClass = 'status-warning';
            statusText = 'AVISO';
        }
        
        statusContainer.innerHTML = `
            <div class="status-indicator ${statusClass}">
                <i class="fas fa-shield-alt"></i>
                <span>${statusText}</span>
            </div>
        `;
        
        document.getElementById('expirationDate').textContent = expirationDate.toLocaleDateString('pt-BR');
        document.getElementById('daysRemaining').textContent = daysRemaining + ' dias';
        detailsContainer.style.display = 'block';
        
    } else {
        statusContainer.innerHTML = `
            <div class="status-indicator status-expired">
                <i class="fas fa-exclamation-triangle"></i>
                <span>EXPIRADA</span>
            </div>
        `;
        detailsContainer.style.display = 'none';
    }
}

function showLicenseError() {
    const statusContainer = document.getElementById('licenseStatus');
    statusContainer.innerHTML = `
        <div class="status-indicator status-error">
            <i class="fas fa-times"></i>
            <span>ERRO</span>
        </div>
    `;
}

async function downloadScript() {
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch('/api/download/script', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'darkfov_loader.py';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast('Download iniciado!', 'success');
            
        } else if (response.status === 403) {
            showToast('Licença expirada. Renove para baixar o script.', 'error');
        } else {
            showToast('Erro ao baixar script', 'error');
        }
        
    } catch (error) {
        console.error('Erro no download:', error);
        showToast('Erro de conexão', 'error');
    }
}

function downloadLoader() {
    // Criar link para download do loader Python
    const loaderContent = `import tkinter as tk
from tkinter import messagebox
import requests
import subprocess
import os

# URL do seu projeto no Replit
API_URL = "https://darkfov.repl.co"
LOGIN_URL = f"{API_URL}/api/login"
LICENSE_URL = f"{API_URL}/api/license/check"
DOWNLOAD_URL = f"{API_URL}/api/download/executable"
EXECUTAVEL = "Script_Dark.exe"

def login():
    email = entry_email.get()
    senha = entry_senha.get()
    
    if not email or not senha:
        messagebox.showwarning("Campos obrigatórios", "Preencha email e senha.")
        return

    try:
        # Login usando Form data conforme o sistema atual
        data = {"email": email, "password": senha}
        res = requests.post(LOGIN_URL, data=data)
        
        if res.status_code != 200:
            messagebox.showerror("Erro", "Login inválido.")
            return
            
        token = res.json()["access_token"]
    except Exception as e:
        messagebox.showerror("Erro", f"Falha na conexão com o servidor: {str(e)}")
        return

    # Verifica licença
    headers = {"Authorization": f"Bearer {token}"}
    try:
        lic = requests.get(LICENSE_URL, headers=headers)
        if lic.status_code != 200:
            messagebox.showwarning("Licença inválida", "Sua licença está expirada ou inválida.")
            return
            
        license_data = lic.json()
        if not license_data.get("valid", False):
            messagebox.showwarning("Licença inválida", "Sua licença está expirada ou inválida.")
            return
            
    except Exception as e:
        messagebox.showerror("Erro", f"Erro ao verificar licença: {str(e)}")
        return

    # Baixa o executável
    try:
        res = requests.get(DOWNLOAD_URL, headers=headers)
        if res.status_code == 200:
            with open(EXECUTAVEL, "wb") as f:
                f.write(res.content)
            messagebox.showinfo("Sucesso", "Script baixado com sucesso! Executando...")
            executar_e_apagar()
        else:
            messagebox.showerror("Erro", "Erro ao baixar o script.")
    except Exception as e:
        messagebox.showerror("Erro", f"Erro no download: {str(e)}")

def executar_e_apagar():
    try:
        # Executa o arquivo
        subprocess.Popen(EXECUTAVEL).wait()
    except Exception as e:
        messagebox.showerror("Erro", f"Erro ao executar: {str(e)}")
    finally:
        # Remove o arquivo após execução
        try:
            os.remove(EXECUTAVEL)
        except:
            pass

def abrir_link():
    import webbrowser
    webbrowser.open(f"{API_URL}/recover-password")

# ----- GUI -----
janela = tk.Tk()
janela.title("FovDark Loader")
janela.geometry("400x320")
janela.configure(bg="#0a0a0f")
janela.resizable(False, False)

# Centralizar janela
janela.eval('tk::PlaceWindow . center')

# Título
tk.Label(janela, text="FovDark", fg="#00fff7", bg="#0a0a0f", font=("Orbitron", 24, "bold")).pack(pady=15)
tk.Label(janela, text="LOADER", fg="#ff00c8", bg="#0a0a0f", font=("Orbitron", 12)).pack(pady=(0, 20))

# Frame principal
frame = tk.Frame(janela, bg="#0a0a0f")
frame.pack(pady=10)

# Email
tk.Label(frame, text="Email", bg="#0a0a0f", fg="#e0e0e0", font=("Arial", 10)).grid(row=0, column=0, sticky="w", pady=(0, 5))
entry_email = tk.Entry(frame, width=35, bg="#1a1a2e", fg="#e0e0e0", insertbackground="#00fff7", relief="flat", bd=5)
entry_email.grid(row=1, column=0, pady=(0, 15))

# Senha
tk.Label(frame, text="Senha", bg="#0a0a0f", fg="#e0e0e0", font=("Arial", 10)).grid(row=2, column=0, sticky="w", pady=(0, 5))
entry_senha = tk.Entry(frame, show="*", width=35, bg="#1a1a2e", fg="#e0e0e0", insertbackground="#00fff7", relief="flat", bd=5)
entry_senha.grid(row=3, column=0, pady=(0, 20))

# Botão de login
btn_login = tk.Button(janela, text="ENTRAR", bg="#00fff7", fg="#000", width=25, height=2, 
                     font=("Arial", 12, "bold"), relief="flat", cursor="hand2", command=login)
btn_login.pack(pady=10)

# Link de recuperação
recup = tk.Label(janela, text="Esqueci minha senha", fg="#ff00c8", bg="#0a0a0f", 
                cursor="hand2", font=("Arial", 9, "underline"))
recup.pack(pady=(10, 0))
recup.bind("<Button-1>", lambda e: abrir_link())

# Bind Enter para login
entry_email.bind("<Return>", lambda e: entry_senha.focus())
entry_senha.bind("<Return>", lambda e: login())

janela.mainloop()
`;
    
    // Criar blob e fazer download
    const blob = new Blob([loaderContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = 'fovdark_loader.py';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    
    showToast('FovDark Loader baixado! Execute com: python fovdark_loader.py', 'success');
}

function downloadManual() {
    const manualContent = `# FOVDARK - MANUAL DE USO

## INSTALAÇÃO E CONFIGURAÇÃO

### 1. Requisitos do Sistema
- Windows 10/11 (64-bit)
- Python 3.8 ou superior
- 4GB de RAM mínimo
- Conexão com internet

### 2. Instalação do Python
1. Baixe o Python em: https://python.org/downloads/
2. Durante a instalação, marque "Add Python to PATH"
3. Execute o comando: pip install tkinter requests

### 3. Download e Execução
1. Baixe o FovDark Loader do painel
2. Execute: python fovdark_loader.py
3. Faça login com suas credenciais
4. O script será baixado e executado automaticamente

## COMO USAR

### 1. Login no Loader
- Digite seu email e senha
- Marque "Salvar login" se desejar
- Clique em "ENTRAR"

### 2. Verificação de Licença
- O sistema verifica automaticamente sua licença
- Se válida, o script será baixado
- Caso expirada, renove no painel web

### 3. Execução do Script
- O script é executado automaticamente
- Configurações são aplicadas
- Após fechar, arquivos temporários são removidos

## CONFIGURAÇÕES

### Teclas Padrão:
- F1: Ativar/Desativar aim assist
- F2: Alternar modo de mira
- F3: Ajustar sensibilidade
- ESC: Fechar script

### Modos de Mira:
- **Automático**: Mira automaticamente nos inimigos
- **Semi-automático**: Assistência de mira
- **Manual**: Apenas indicadores visuais

## TROUBLESHOOTING

### Problemas Comuns:

**Erro de conexão:**
- Verifique sua internet
- Desative temporariamente o antivírus
- Execute como administrador

**Script não executa:**
- Verifique se o BloodStrike está em tela cheia
- Execute o jogo antes do script
- Verifique se a licença está ativa

**Licença expirada:**
- Acesse o painel web
- Clique em "Renovar Licença"
- Efetue o pagamento

### Suporte Técnico:
- Discord: [Link do Discord]
- Telegram: [Link do Telegram]
- Email: suporte@fovdark.com

## AVISOS IMPORTANTES

⚠️ **ATENÇÃO:**
- Use apenas em modos de treino
- Não use em partidas ranqueadas
- Respeite os termos de uso do jogo
- O uso é por sua conta e risco

🔒 **SEGURANÇA:**
- Nunca compartilhe suas credenciais
- Mantenha o loader sempre atualizado
- Use apenas o loader oficial

## ATUALIZAÇÕES

O sistema verifica automaticamente por atualizações.
Sempre use a versão mais recente para melhor compatibilidade.

---
© 2024 FovDark - Todos os direitos reservados
`;
    
    // Criar blob e fazer download
    const blob = new Blob([manualContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = 'FovDark_Manual.txt';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    
    showToast('Manual de uso baixado!', 'success');
}

function downloadConfigs() {
    showToast('Configurações serão disponibilizadas em breve', 'info');
}

function openSupportModal() {
    document.getElementById('supportModal').style.display = 'flex';
}

function openSettingsModal() {
    showToast('Configurações em desenvolvimento', 'info');
}

function checkUpdates() {
    showToast('Verificando atualizações...', 'info');
    setTimeout(() => {
        showToast('Sistema atualizado!', 'success');
    }, 2000);
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Fechar modal clicando fora
window.addEventListener('click', function(e) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
