{% extends "base.html" %}

{% block title %}Painel - DarkFov{% endblock %}

{% block content %}
<section class="dashboard-section">
    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h1>Painel <span class="highlight">DarkFov</span></h1>
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-details">
                    <span class="user-email" id="userEmail">carregando...</span>
                    <span class="user-since">Membro desde <span id="userSince">2024</span></span>
                </div>
            </div>
        </div>

        <!-- Success Message -->
        <div id="successMessage" class="success-message" style="display: none;">
            <i class="fas fa-check-circle"></i>
            <span>Operação realizada com sucesso!</span>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Status da Licença - Card Principal -->
            <div class="dashboard-card license-status-card">
                <div class="card-header">
                    <h2><i class="fas fa-shield-alt"></i> Status da Licença</h2>
                </div>
                <div class="card-content">
                    <div class="license-status" id="licenseStatus">
                        <div class="status-indicator status-loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Verificando...</span>
                        </div>
                    </div>
                    <div class="license-details" id="licenseDetails" style="display: none;">
                        <div class="license-info-grid">
                            <div class="license-info-item">
                                <span class="label">Expira em:</span>
                                <span class="value" id="expirationDate">-</span>
                            </div>
                            <div class="license-info-item">
                                <span class="label">Dias restantes:</span>
                                <span class="value" id="daysRemaining">-</span>
                            </div>
                            <div class="license-info-item">
                                <span class="label">Chave da Licença:</span>
                                <span class="value license-key" id="licenseKey">-</span>
                            </div>
                            <div class="license-info-item">
                                <span class="label">Última verificação:</span>
                                <span class="value" id="lastCheck">Agora</span>
                            </div>
                        </div>
                    </div>
                    <div class="license-inactive" id="licenseInactive" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="inactive-content">
                            <h3>Sem Licença Ativa</h3>
                            <p>Adquira uma licença para acessar o DarkFov Aimbot</p>
                            <a href="/comprar" class="btn btn-primary">
                                <i class="fas fa-shopping-cart"></i>
                                Comprar Agora
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Download Card -->
            <div class="dashboard-card download-card">
                <div class="card-header">
                    <h2><i class="fas fa-download"></i> Downloads</h2>
                </div>
                <div class="card-content">
                    <div class="download-section" id="downloadSection">
                        <div class="download-item">
                            <div class="download-icon">
                                <i class="fas fa-file-code"></i>
                            </div>
                            <div class="download-info">
                                <h3>Script Principal</h3>
                                <p>Loader principal do DarkFov</p>
                                <span class="version">v2.1.0</span>
                            </div>
                            <button class="btn btn-primary" onclick="downloadScript()">
                                <i class="fas fa-download"></i>
                                Baixar
                            </button>
                        </div>

                        <div class="download-item">
                            <div class="download-icon">
                                <i class="fas fa-desktop"></i>
                            </div>
                            <div class="download-info">
                                <h3>Desktop Loader</h3>
                                <p>Aplicativo para Windows</p>
                                <span class="version">v2.1.0</span>
                            </div>
                            <button class="btn btn-outline" onclick="downloadLoader()">
                                <i class="fas fa-download"></i>
                                Baixar
                            </button>
                        </div>

                        <div class="download-item">
                            <div class="download-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="download-info">
                                <h3>Manual de Uso</h3>
                                <p>Guia completo de instalação</p>
                                <span class="version">Atualizado</span>
                            </div>
                            <button class="btn btn-outline" onclick="downloadManual()">
                                <i class="fas fa-download"></i>
                                Baixar
                            </button>
                        </div>
                    </div>

                    <div class="download-locked" id="downloadLocked" style="display: none;">
                        <i class="fas fa-lock"></i>
                        <h3>Downloads Bloqueados</h3>
                        <p>Download disponível apenas para usuários com licença ativa</p>
                        <a href="/comprar" class="btn btn-secondary">Adquirir Licença</a>
                    </div>
                </div>
            </div>

            <!-- Tutorial Card -->
            <div class="dashboard-card tutorial-card">
                <div class="card-header">
                    <h2><i class="fas fa-book-open"></i> Como Usar</h2>
                </div>
                <div class="card-content">
                    <div class="tutorial-steps">
                        <div class="tutorial-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h3>Download</h3>
                                <p>Baixe o loader do DarkFov</p>
                            </div>
                        </div>
                        <div class="tutorial-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h3>Execução</h3>
                                <p>Execute como administrador</p>
                            </div>
                        </div>
                        <div class="tutorial-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h3>Configuração</h3>
                                <p>Configure suas preferências</p>
                            </div>
                        </div>
                        <div class="tutorial-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h3>Jogo</h3>
                                <p>Inicie o BloodStrike</p>
                            </div>
                        </div>
                    </div>

                    <div class="tutorial-tips">
                        <h4><i class="fas fa-lightbulb"></i> Dicas Importantes</h4>
                        <ul>
                            <li>Execute sempre como administrador</li>
                            <li>Desative antivírus temporariamente</li>
                            <li>Use apenas em modo offline</li>
                            <li>Mantenha o loader sempre atualizado</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- System Status Card -->
            <div class="dashboard-card system-card">
                <div class="card-header">
                    <h2><i class="fas fa-server"></i> Status do Sistema</h2>
                    <span class="status-badge online">Online</span>
                </div>
                <div class="card-content">
                    <div class="system-metrics">
                        <div class="metric-item">
                            <div class="metric-icon">
                                <i class="fas fa-tachometer-alt"></i>
                            </div>
                            <div class="metric-info">
                                <span class="metric-value">98%</span>
                                <span class="metric-label">Uptime</span>
                            </div>
                        </div>

                        <div class="metric-item">
                            <div class="metric-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="metric-info">
                                <span class="metric-value">Ativo</span>
                                <span class="metric-label">Anti-Detecção</span>
                            </div>
                        </div>

                        <div class="metric-item">
                            <div class="metric-icon">
                                <i class="fas fa-sync-alt"></i>
                            </div>
                            <div class="metric-info">
                                <span class="metric-value">v2.1.0</span>
                                <span class="metric-label">Versão Atual</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Support Card -->
            <div class="dashboard-card support-card">
                <div class="card-header">
                    <h2><i class="fas fa-headset"></i> Suporte</h2>
                </div>
                <div class="card-content">
                    <div class="support-options">
                        <div class="support-option">
                            <div class="support-icon discord">
                                <i class="fab fa-discord"></i>
                            </div>
                            <div class="support-info">
                                <h3>Discord</h3>
                                <p>Suporte em tempo real</p>
                                <span class="status-online">🟢 Online</span>
                            </div>
                            <button class="btn btn-primary small" onclick="openSupportModal()">Entrar</button>
                        </div>

                        <div class="support-option">
                            <div class="support-icon telegram">
                                <i class="fab fa-telegram"></i>
                            </div>
                            <div class="support-info">
                                <h3>Telegram</h3>
                                <p>Grupo exclusivo</p>
                                <span class="status-online">🟢 Online</span>
                            </div>
                            <button class="btn btn-outline small" onclick="openSupportModal()">Acessar</button>
                        </div>

                        <div class="support-option">
                            <div class="support-icon email">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="support-info">
                                <h3>Email</h3>
                                <p>suporte@darkfov.com</p>
                                <span class="status-available">📧 24h</span>
                            </div>
                            <a href="mailto:suporte@darkfov.com" class="btn btn-outline small">Enviar</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Stats Card -->
            <div class="dashboard-card stats-card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-bar"></i> Estatísticas</h2>
                </div>
                <div class="card-content">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">15</div>
                            <div class="stat-label">Downloads</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">30</div>
                            <div class="stat-label">Dias Ativos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">99%</div>
                            <div class="stat-label">Satisfação</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">24/7</div>
                            <div class="stat-label">Suporte</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Support Modal -->
<div id="supportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Suporte Técnico</h2>
            <button class="modal-close" onclick="closeModal('supportModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="support-channels">
                <div class="support-channel">
                    <div class="channel-icon discord">
                        <i class="fab fa-discord"></i>
                    </div>
                    <div class="channel-info">
                        <h3>Discord</h3>
                        <p>Chat em tempo real com a comunidade e suporte</p>
                        <p class="channel-status">🟢 Online - Resposta em minutos</p>
                    </div>
                    <a href="#" class="btn btn-primary">Entrar</a>
                </div>

                <div class="support-channel">
                    <div class="channel-icon telegram">
                        <i class="fab fa-telegram"></i>
                    </div>
                    <div class="channel-info">
                        <h3>Telegram</h3>
                        <p>Suporte direto via mensagens privadas</p>
                        <p class="channel-status">🟢 Online - Resposta em até 1h</p>
                    </div>
                    <a href="#" class="btn btn-outline">Contatar</a>
                </div>

                <div class="support-channel">
                    <div class="channel-icon ticket">
                        <i class="fas fa-ticket-alt"></i>
                    </div>
                    <div class="channel-info">
                        <h3>Sistema de Tickets</h3>
                        <p>Para problemas técnicos específicos</p>
                        <p class="channel-status">📧 Email - Resposta em até 24h</p>
                    </div>
                    <a href="#" class="btn btn-outline">Abrir Ticket</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    checkAuthentication();
    loadUserData();
    checkLicenseStatus();

    // Verificar se há parâmetro de sucesso na URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('compra') === 'sucesso') {
        showSuccessMessage('Compra realizada com sucesso! Sua licença foi ativada.');
    }
});

function checkAuthentication() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login';
        return;
    }
}

function loadUserData() {
    const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
    if (userData.email) {
        document.getElementById('userEmail').textContent = userData.email;

        // Calcular data de criação aproximada
        const createdDate = userData.created_at ? new Date(userData.created_at) : new Date();
        document.getElementById('userSince').textContent = createdDate.getFullYear();
    }
}

async function checkLicenseStatus() {
    const token = localStorage.getItem('access_token');

    try {
        const response = await fetch('/api/license/check', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const data = await response.json();

        if (response.ok) {
            updateLicenseDisplay(data);
        } else {
            if (response.status === 401) {
                localStorage.clear();
                window.location.href = '/login';
            } else {
                showLicenseError();
            }
        }

    } catch (error) {
        console.error('Erro ao verificar licença:', error);
        showLicenseError();
    }
}

function updateLicenseDisplay(licenseData) {
    const statusContainer = document.getElementById('licenseStatus');
    const detailsContainer = document.getElementById('licenseDetails');
    const inactiveContainer = document.getElementById('licenseInactive');
    const downloadSection = document.getElementById('downloadSection');
    const downloadLocked = document.getElementById('downloadLocked');

    if (licenseData.valid) {
        const expirationDate = new Date(licenseData.data_expiracao);
        const now = new Date();
        const daysRemaining = Math.ceil((expirationDate - now) / (1000 * 60 * 60 * 24));

        let statusClass = 'status-active';
        let statusText = 'ATIVA';
        let statusIcon = 'fas fa-check-circle';

        if (daysRemaining <= 3) {
            statusClass = 'status-critical';
            statusText = 'CRÍTICO';
            statusIcon = 'fas fa-exclamation-triangle';
        } else if (daysRemaining <= 7) {
            statusClass = 'status-warning';
            statusText = 'ATENÇÃO';
            statusIcon = 'fas fa-exclamation-circle';
        }

        statusContainer.innerHTML = `
            <div class="license-active">
                <i class="${statusIcon}"></i>
                <span>Licença ${statusText}</span>
            </div>
        `;

        document.getElementById('expirationDate').textContent = expirationDate.toLocaleDateString('pt-BR');
        document.getElementById('daysRemaining').textContent = daysRemaining + ' dias';
        document.getElementById('licenseKey').textContent = licenseData.chave_licenca ? 
            licenseData.chave_licenca.substring(0, 8) + '...' + licenseData.chave_licenca.slice(-8) : 'N/A';
        document.getElementById('lastCheck').textContent = 'Agora';

        detailsContainer.style.display = 'block';
        inactiveContainer.style.display = 'none';
        downloadSection.style.display = 'block';
        downloadLocked.style.display = 'none';

    } else {
        statusContainer.innerHTML = `
            <div class="license-inactive">
                <i class="fas fa-times-circle"></i>
                <span>SEM LICENÇA</span>
            </div>
        `;
        detailsContainer.style.display = 'none';
        inactiveContainer.style.display = 'block';
        downloadSection.style.display = 'none';
        downloadLocked.style.display = 'block';
    }
}

function showLicenseError() {
    const statusContainer = document.getElementById('licenseStatus');
    statusContainer.innerHTML = `
        <div class="status-indicator status-error">
            <i class="fas fa-exclamation-triangle"></i>
            <span>ERRO DE CONEXÃO</span>
        </div>
    `;
}

function showSuccessMessage(message) {
    const successMsg = document.getElementById('successMessage');
    successMsg.querySelector('span').textContent = message;
    successMsg.style.display = 'flex';

    setTimeout(() => {
        successMsg.style.display = 'none';
    }, 5000);
}

async function downloadScript() {
    const token = localStorage.getItem('access_token');

    try {
        const response = await fetch('/api/download/script', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'darkfov_loader.py';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);

            showToast('Download iniciado com sucesso!', 'success');

        } else if (response.status === 403) {
            showToast('Licença expirada. Renove para baixar o script.', 'error');
        } else {
            showToast('Erro ao baixar script', 'error');
        }

    } catch (error) {
        console.error('Erro no download:', error);
        showToast('Erro de conexão', 'error');
    }
}

function downloadLoader() {
    // Código do loader desktop (mantendo o mesmo código anterior)
    const loaderContent = `import tkinter as tk
from tkinter import messagebox
import requests
import subprocess
import os
import json
import webbrowser
from datetime import datetime

# Configurações
API_URL = "https://darkfov.repl.co"
LOGIN_URL = f"{API_URL}/api/login"
LICENSE_URL = f"{API_URL}/api/license/check"
DOWNLOAD_URL = f"{API_URL}/api/download/executable"

class DarkFovLoader:
    def __init__(self):
        self.setup_window()

    def setup_window(self):
        self.janela = tk.Tk()
        self.janela.title("DarkFov Loader v2.1")
        self.janela.geometry("400x300")
        self.janela.configure(bg="#0a0a0f")
        self.janela.resizable(False, False)

        # Título
        tk.Label(self.janela, text="DarkFov", fg="#00fff7", bg="#0a0a0f", 
                font=("Orbitron", 24, "bold")).pack(pady=20)

        # Campos de login
        tk.Label(self.janela, text="Email", bg="#0a0a0f", fg="#e0e0e0").pack()
        self.entry_email = tk.Entry(self.janela, width=40, bg="#1a1a2e", fg="#e0e0e0")
        self.entry_email.pack(pady=5)

        tk.Label(self.janela, text="Senha", bg="#0a0a0f", fg="#e0e0e0").pack()
        self.entry_senha = tk.Entry(self.janela, show="*", width=40, bg="#1a1a2e", fg="#e0e0e0")
        self.entry_senha.pack(pady=5)

        # Botão de login
        self.btn_login = tk.Button(self.janela, text="ENTRAR", bg="#00fff7", fg="#000", 
                                  width=30, height=2, command=self.login)
        self.btn_login.pack(pady=20)

    def login(self):
        # Implementar lógica de login
        messagebox.showinfo("Info", "Loader em desenvolvimento!")

    def run(self):
        self.janela.mainloop()

if __name__ == "__main__":
    loader = DarkFovLoader()
    loader.run()
`;

    const blob = new Blob([loaderContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = 'DarkFov_Loader_v2.1.py';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);

    showToast('Loader Desktop baixado!', 'success');
}

function downloadManual() {
    const manualContent = `# DARKFOV - MANUAL DO USUÁRIO

## Instalação
1. Baixe o loader
2. Execute como administrador
3. Faça login com suas credenciais
4. Execute o BloodStrike
5. Aproveite!

## Controles
- F1: Ativar/Desativar
- F2: Modo de mira
- F3: Sensibilidade
- ESC: Fechar

## Suporte
Discord: discord.gg/darkfov
Email: suporte@darkfov.com
`;

    const blob = new Blob([manualContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = 'DarkFov_Manual.txt';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);

    showToast('Manual baixado!', 'success');
}

function openSupportModal() {
    document.getElementById('supportModal').style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Fechar modal clicando fora
window.addEventListener('click', function(e) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
});
</script>
{% endblock %}