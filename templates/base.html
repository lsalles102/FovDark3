<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>
            {% block title %}FovDark - Aim Assist Premium{% endblock %}
        </title>

        <!-- SEO Meta Tags -->
        <meta
            name="description"
            content="FovDark - O aimbot mais avançado para BloodStrike. Recursos premium, anti-detecção e suporte 24/7."
        />
        <meta
            name="keywords"
            content="aimbot, aim assist, BloodStrike, gaming, precision, anti-cheat"
        />
        <meta name="author" content="FovDark" />

        <!-- Open Graph -->
        <meta property="og:title" content="FovDark - Aim Assist Premium" />
        <meta
            property="og:description"
            content="Domine o campo de batalha com o aimbot mais avançado do mercado"
        />
        <meta property="og:type" content="website" />

        <!-- Favicon -->
        <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />

        <!-- Security Headers -->
        <meta
            http-equiv="Content-Security-Policy"
            content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https:; img-src 'self' data: https:;"
        />
        <meta http-equiv="X-Content-Type-Options" content="nosniff" />
        <meta http-equiv="X-Frame-Options" content="DENY" />
        <meta http-equiv="X-XSS-Protection" content="1; mode=block" />

        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&family=Nunito:wght@300;400;500;600;700&family=Open+Sans:wght@300;400;500;600;700&family=Exo+2:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />

        <!-- Font Awesome -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/static/style.css" />

        {% block extra_head %}{% endblock %}

        <!-- Carregar configurações dinâmicas -->
        <script>
            async function loadSiteSettings() {
                try {
                    const response = await fetch("/api/settings/public");
                    if (response.ok) {
                        const settings = await response.json();
                        applySiteSettings(settings);
                    }
                } catch (error) {
                    console.log("Configurações padrão carregadas");
                }
            }

            function applySiteSettings(settings) {
                const root = document.documentElement;

                // Aplicar configurações de tema
                if (settings.theme) {
                    Object.entries(settings.theme).forEach(([key, value]) => {
                        if (key.includes("color")) {
                            const hsl = hexToHSL(value);
                            const cssVar = key.replace("-color", "");
                            root.style.setProperty(`--${cssVar}`, hsl);
                        } else if (key.includes("font")) {
                            root.style.setProperty(
                                `--${key}`,
                                `'${value}', ${key.includes("primary") ? "monospace" : "sans-serif"}`,
                            );
                        }
                    });
                }

                // Aplicar configurações de conteúdo
                if (settings.content) {
                    if (settings.content["site-name"]) {
                        document.title = document.title.replace(
                            "FovDark",
                            settings.content["site-name"],
                        );

                        // Atualizar brand name se existir
                        const brandElements = document.querySelectorAll(
                            ".brand-name, .site-name",
                        );
                        brandElements.forEach((el) => {
                            el.textContent = settings.content["site-name"];
                        });
                    }
                }

                // Aplicar imagens
                if (settings.images) {
                    if (settings.images["favicon"]) {
                        const favicon =
                            document.querySelector('link[rel="icon"]');
                        if (favicon) favicon.href = settings.images["favicon"];
                    }

                    if (settings.images["main-logo"]) {
                        const logos = document.querySelectorAll(
                            ".main-logo, .site-logo",
                        );
                        logos.forEach((logo) => {
                            if (logo.tagName === "IMG") {
                                logo.src = settings.images["main-logo"];
                            }
                        });
                    }
                }
            }

            function hexToHSL(hex) {
                if (!hex || !hex.startsWith("#")) return hex;

                const r = parseInt(hex.slice(1, 3), 16) / 255;
                const g = parseInt(hex.slice(3, 5), 16) / 255;
                const b = parseInt(hex.slice(5, 7), 16) / 255;

                const max = Math.max(r, g, b);
                const min = Math.min(r, g, b);
                let h,
                    s,
                    l = (max + min) / 2;

                if (max === min) {
                    h = s = 0;
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

                    switch (max) {
                        case r:
                            h = (g - b) / d + (g < b ? 6 : 0);
                            break;
                        case g:
                            h = (b - r) / d + 2;
                            break;
                        case b:
                            h = (r - g) / d + 4;
                            break;
                    }
                    h /= 6;
                }

                h = Math.round(h * 360);
                s = Math.round(s * 100);
                l = Math.round(l * 100);

                return `${h} ${s}% ${l}%`;
            }

            // Carregar configurações quando a página carregar
            document.addEventListener("DOMContentLoaded", loadSiteSettings);
        </script>
    </head>
    <body>
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-brand">
                    <a href="/" class="brand-link">
                        <i class="fas fa-crosshairs"></i>
                        <span>FovDark</span>
                    </a>
                </div>
                
                <div class="nav-menu">
                    <a href="/" class="nav-link">Início</a>
                    <a href="/comprar" class="nav-link">Comprar</a>
                    <a href="/login" class="nav-link login-btn">Login</a>
                    <a href="/register" class="nav-link register-btn">Registrar</a>
                </div>
                
                <div class="nav-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </nav>
                </div>

                <div class="nav-menu" id="navMenu">
                    <a href="/" class="nav-link">
                        <i class="fas fa-home"></i>
                        <span>Início</span>
                    </a>
                    <a href="/comprar" class="nav-link">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Comprar</span>
                    </a>
                    <a
                        href="/painel"
                        class="nav-link"
                        id="painelLink"
                        style="display: none"
                    >
                        <i class="fas fa-dashboard"></i>
                        <span>Painel</span>
                    </a>
                    <a
                        href="/admin"
                        class="nav-link"
                        id="adminLink"
                        style="display: none"
                    >
                        <i class="fas fa-cog"></i>
                        <span>Admin</span>
                    </a>
                    <a href="/login" class="nav-link" id="loginLink">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Login</span>
                    </a>
                    <a
                        href="#"
                        class="nav-link"
                        id="logoutLink"
                        style="display: none"
                        onclick="logout()"
                    >
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sair</span>
                    </a>
                </div>

                <div class="nav-toggle" id="navToggle">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">{% block content %}{% endblock %}</main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section">
                        <h3>FovDark</h3>
                        <p>
                            Sistema avançado Anti-Detection. Precisão letal,
                            vantagem total.
                        </p>
                    </div>

                    <div class="footer-section">
                        <h4>Links Rápidos</h4>
                        <ul>
                            <li><a href="/">Início</a></li>
                            <li><a href="/comprar">Comprar</a></li>
                            <li><a href="/painel">Painel</a></li>
                        </ul>
                    </div>

                    <div class="footer-section">
                        <h4>Suporte</h4>
                        <ul>
                            <li><a href="#">Discord</a></li>
                        </ul>
                    </div>
                </div>

                <div class="footer-bottom">
                    <p>&copy; 2024 FovDark. Todos os direitos reservados.</p>
                </div>
            </div>
        </footer>

        <!-- Toast Notifications -->
        <div id="toast-container" class="toast-container"></div>

        <!-- Scripts -->
        <script src="/static/script.js" defer></script>
        <script>
            // Inicialização após carregamento do DOM
            document.addEventListener('DOMContentLoaded', function() {
                console.log('✅ DOM carregado, inicializando sistema');
                
                // Aguardar um pouco para garantir que o script.js foi carregado
                setTimeout(function() {
                    try {
                        // Primeiro atualizar a UI imediatamente
                        if (typeof updateAuthenticationUI === 'function') {
                            console.log('🎨 Atualizando UI de autenticação');
                            updateAuthenticationUI();
                        } else {
                            console.warn('⚠️ Função updateAuthenticationUI não encontrada');
                        }
                        
                        // Depois verificar o status de autenticação
                        if (typeof checkAuthenticationStatus === 'function') {
                            console.log('🔍 Verificando status de autenticação');
                            checkAuthenticationStatus();
                        } else {
                            console.warn('⚠️ Função checkAuthenticationStatus não encontrada');
                        }
                    } catch (error) {
                        console.error('❌ Erro na inicialização:', error);
                    }
                }, 100);
                
                // Verificação adicional após mais tempo
                setTimeout(function() {
                    try {
                        if (typeof updateAuthenticationUI === 'function') {
                            console.log('🔄 Verificação adicional da UI');
                            updateAuthenticationUI();
                        }
                    } catch (error) {
                        console.error('❌ Erro na verificação adicional:', error);
                    }
                }, 1000);
            });

            // Verificação de visibilidade da página
            let pageHiddenTime = null;
            let authCheckInterval = null;
            
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    pageHiddenTime = Date.now();
                    // Parar verificações quando a página está oculta
                    if (authCheckInterval) {
                        clearInterval(authCheckInterval);
                        authCheckInterval = null;
                    }
                } else {
                    // Verificar autenticação quando a página volta ao foco
                    if (pageHiddenTime && (Date.now() - pageHiddenTime) > 300000) { // 5 minutos
                        console.log('⏰ Página oculta por muito tempo, verificando autenticação');
                        if (typeof checkAuthenticationStatus === 'function') {
                            checkAuthenticationStatus();
                        }
                    }
                    pageHiddenTime = null;
                    
                    // Reiniciar verificações periódicas
                    if (localStorage.getItem('access_token')) {
                        authCheckInterval = setInterval(function() {
                            if (typeof checkAuthenticationStatus === 'function') {
                                checkAuthenticationStatus();
                            }
                        }, 60000); // A cada minuto quando a página está ativa
                    }
                }
            });

            // Verificar mudanças no localStorage (múltiplas abas)
            window.addEventListener('storage', function(e) {
                if (e.key === 'access_token' || e.key === 'user_data' || e.key === 'authToken' || e.key === 'userData') {
                    console.log('💾 Dados de autenticação mudaram em outra aba');
                    setTimeout(function() {
                        if (typeof updateAuthenticationUI === 'function') {
                            updateAuthenticationUI();
                        }
                        if (typeof checkAuthenticationStatus === 'function') {
                            checkAuthenticationStatus();
                        }
                    }, 100);
                }
            });

            // Verificação periódica inicial
            window.addEventListener('load', function() {
                const token = localStorage.getItem('access_token') || localStorage.getItem('authToken');
                if (token) {
                    authCheckInterval = setInterval(function() {
                        if (typeof checkAuthenticationStatus === 'function') {
                            checkAuthenticationStatus();
                        }
                    }, 60000); // A cada minuto
                }
            });
        </script>
        
        {% block scripts %}{% endblock %}
    </body>
</html>