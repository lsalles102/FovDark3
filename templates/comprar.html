{% extends "base.html" %}

{% block title %}Comprar - FovDark{% endblock %}

{% block content %}
<section class="purchase-section">
    <div class="container">
        <div class="purchase-header">
            <h1>ESCOLHA SEU PLANO</h1>
            <p>Domine o campo de batalha com precisão absoluta</p>
        </div>

        <div class="pricing-grid">
            <!-- Card Mensal -->
            <div class="pricing-card">
                <div class="card-header">
                    <h3>MENSAL</h3>
                    <div class="price">
                        <span class="currency">R$</span>
                        <span class="amount">29</span>
                        <span class="period">,90/mês</span>
                    </div>
                </div>

                <div class="card-body">
                    <ul class="pricing-features">
                        <li><i class="fas fa-check"></i> Aim Assist Inteligente</li>
                        <li><i class="fas fa-check"></i> Anti-Detecção Ativo</li>
                        <li><i class="fas fa-check"></i> Suporte via Discord</li>
                        <li><i class="fas fa-check"></i> Atualizações Gratuitas</li>
                        <li><i class="fas fa-check"></i> Configurações Básicas</li>
                    </ul>

                    <button class="btn btn-primary btn-full" onclick="selectPlan('mensal', 29.90)">
                        <i class="fas fa-shopping-cart"></i>
                        ESCOLHER PLANO
                    </button>
                </div>
            </div>

            <!-- Card Trimestral (Mais Popular) -->
            <div class="pricing-card pricing-popular">
                <div class="popular-badge">MAIS POPULAR</div>
                <div class="card-header">
                    <h3>TRIMESTRAL</h3>
                    <div class="price">
                        <span class="currency">R$</span>
                        <span class="amount">79</span>
                        <span class="period">,90/3 meses</span>
                    </div>
                    <div class="savings">Economize 28%</div>
                </div>

                <div class="card-body">
                    <ul class="pricing-features">
                        <li><i class="fas fa-check"></i> Tudo do plano mensal</li>
                        <li><i class="fas fa-check"></i> Configurações Premium</li>
                        <li><i class="fas fa-check"></i> Suporte Prioritário</li>
                        <li><i class="fas fa-check"></i> Acesso Antecipado</li>
                        <li><i class="fas fa-check"></i> Recursos Avançados</li>
                    </ul>

                    <button class="btn btn-primary btn-full" onclick="selectPlan('trimestral', 79.90)">
                        <i class="fas fa-crown"></i>
                        ESCOLHER PLANO
                    </button>
                </div>
            </div>

            <!-- Card Anual -->
            <div class="pricing-card">
                <div class="card-header">
                    <h3>ANUAL</h3>
                    <div class="price">
                        <span class="currency">R$</span>
                        <span class="amount">299</span>
                        <span class="period">,90/ano</span>
                    </div>
                    <div class="savings">Economize 43%</div>
                </div>

                <div class="card-body">
                    <ul class="pricing-features">
                        <li><i class="fas fa-check"></i> Tudo dos planos anteriores</li>
                        <li><i class="fas fa-check"></i> Recursos Exclusivos</li>
                        <li><i class="fas fa-check"></i> Suporte VIP 24/7</li>
                        <li><i class="fas fa-check"></i> Beta Access</li>
                        <li><i class="fas fa-check"></i> Configurações Elite</li>
                    </ul>

                    <button class="btn btn-primary btn-full" onclick="selectPlan('anual', 199.90)">
                        <i class="fas fa-star"></i>
                        ESCOLHER PLANO
                    </button>
                </div>
            </div>
        </div>

        <!-- Seção de Recursos -->
        <div class="features-comparison">
            <h2>COMPARAÇÃO DE RECURSOS</h2>
            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>Recursos</th>
                            <th>Mensal</th>
                            <th>Trimestral</th>
                            <th>Anual</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Aim Assist Inteligente</td>
                            <td><i class="fas fa-check text-success"></i></td>
                            <td><i class="fas fa-check text-success"></i></td>
                            <td><i class="fas fa-check text-success"></i></td>
                        </tr>
                        <tr>
                            <td>Anti-detecção</td>
                            <td><i class="fas fa-check text-success"></i></td>
                            <td><i class="fas fa-check text-success"></i></td>
                            <td><i class="fas fa-check text-success"></i></td>
                        </tr>
                        <tr>
                            <td>Configurações Premium</td>
                            <td><i class="fas fa-times text-danger"></i></td>
                            <td><i class="fas fa-check text-success"></i></td>
                            <td><i class="fas fa-check text-success"></i></td>
                        </tr>
                        <tr>
                            <td>Suporte Prioritário</td>
                            <td><i class="fas fa-times text-danger"></i></td>
                            <td><i class="fas fa-check text-success"></i></td>
                            <td><i class="fas fa-check text-success"></i></td>
                        </tr>
                        <tr>
                            <td>Recursos Exclusivos</td>
                            <td><i class="fas fa-times text-danger"></i></td>
                            <td><i class="fas fa-times text-danger"></i></td>
                            <td><i class="fas fa-check text-success"></i></td>
                        </tr>
                        <tr>
                            <td>Beta Access</td>
                            <td><i class="fas fa-times text-danger"></i></td>
                            <td><i class="fas fa-times text-danger"></i></td>
                            <td><i class="fas fa-check text-success"></i></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Badges de Segurança -->
        <div class="trust-badges">
            <div class="trust-item">
                <div class="trust-icon ssl">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="trust-info">
                    <h4>SSL Seguro</h4>
                    <p>Conexão criptografada</p>
                </div>
            </div>

            <div class="trust-item">
                <div class="trust-icon secure">
                    <i class="fas fa-lock"></i>
                </div>
                <div class="trust-info">
                    <h4>Pagamentos Seguros</h4>
                    <p>Processamento confiável</p>
                </div>
            </div>

            <div class="trust-item">
                <div class="trust-icon verified">
                    <i class="fas fa-certificate"></i>
                </div>
                <div class="trust-info">
                    <h4>Site Verificado</h4>
                    <p>Empresa registrada</p>
                </div>
            </div>

            <div class="trust-item">
                <div class="trust-icon privacy">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="trust-info">
                    <h4>Privacidade</h4>
                    <p>Dados protegidos</p>
                </div>
            </div>
        </div>

        <!-- Avaliações dos Clientes -->
        <div class="reviews-section">
            <h2>AVALIAÇÕES DOS CLIENTES</h2>
            <div class="reviews-grid">
                <div class="review-card">
                    <div class="review-rating">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                    </div>
                    <p class="review-text">"Excelente produto! O aim assist funciona perfeitamente e o suporte é muito rápido. Recomendo!"</p>
                    <div class="review-author">
                        <div class="author-avatar">JS</div>
                        <div class="author-info">
                            <div class="author-name">João Silva</div>
                            <div class="author-date">Há 2 dias</div>
                        </div>
                    </div>
                </div>

                <div class="review-card">
                    <div class="review-rating">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                    </div>
                    <p class="review-text">"O melhor aim assist que já usei! Vale cada centavo investido. Sistema anti-detecção funciona perfeitamente."</p>
                    <div class="review-author">
                        <div class="author-avatar">MS</div>
                        <div class="author-info">
                            <div class="author-name">Maria Santos</div>
                            <div class="author-date">Há 1 semana</div>
                        </div>
                    </div>
                </div>

                <div class="review-card">
                    <div class="review-rating">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                    </div>
                    <p class="review-text">"Produto incrível! Nunca fui detectado e minha precisão melhorou muito. Suporte técnico nota 10!"</p>
                    <div class="review-author">
                        <div class="author-avatar">PC</div>
                        <div class="author-info">
                            <div class="author-name">Pedro Costa</div>
                            <div class="author-date">Há 3 dias</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAQ -->
        <div class="faq-section">
            <h2>PERGUNTAS FREQUENTES</h2>
            <div class="faq-list">
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>É SEGURO USAR O DARKFOV?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Sim. Nosso software utiliza tecnologia avançada de bypass que analisa automaticamente para evitar detecção. Mantemos nossos métodos privados para garantir máxima segurança.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>COMO FUNCIONA O SISTEMA DE LICENÇAS?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Após a compra, você recebe uma licença única vinculada ao seu e-mail. A licença é válida por 30, 90 ou 365 dias dependendo do plano escolhido.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>POSSO USAR EM MAIS DE UM COMPUTADOR?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Cada licença permite uso em até 2 computadores diferentes. Para mais dispositivos, será necessário adquirir licenças adicionais.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>COMO RECEBO ATUALIZAÇÕES?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>As atualizações são automáticas e gratuitas durante todo o período da sua licença. Você será notificado quando uma nova versão estiver disponível.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal de Checkout Melhorado -->
<div id="checkoutModal" class="checkout-modal-overlay">
    <div class="checkout-modal">
        <div class="checkout-header">
            <div class="checkout-title">
                <i class="fas fa-shopping-cart"></i>
                <h3>FINALIZAR COMPRA</h3>
            </div>
            <button class="checkout-close" onclick="closeCheckoutModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="checkout-body">
            <div id="loginPrompt" style="display: none;">
                <div class="auth-prompt">
                    <div class="auth-icon">
                        <i class="fas fa-user-lock"></i>
                    </div>
                    <h4>LOGIN NECESSÁRIO</h4>
                    <p>Entre na sua conta para continuar:</p>
                    <div class="auth-actions">
                        <a href="/login?redirect=comprar" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i>
                            FAZER LOGIN
                        </a>
                        <a href="/register" class="btn btn-outline">
                            <i class="fas fa-user-plus"></i>
                            CRIAR CONTA
                        </a>
                    </div>
                </div>
            </div>

            <div id="checkoutForm" style="display: none;">
                <div class="order-card">
                    <div class="order-header">
                        <i class="fas fa-receipt"></i>
                        <h4>RESUMO DO PEDIDO</h4>
                    </div>
                    
                    <div class="order-details">
                        <div class="order-item">
                            <span class="item-label">Produto:</span>
                            <span id="selectedPlan" class="item-value"></span>
                        </div>
                        <div class="order-item">
                            <span class="item-label">Duração:</span>
                            <span id="selectedDuration" class="item-value"></span>
                        </div>
                        <div class="order-separator"></div>
                        <div class="order-item total">
                            <span class="item-label">TOTAL:</span>
                            <span id="selectedPrice" class="item-price"></span>
                        </div>
                    </div>
                </div>

                <div class="payment-methods">
                    <h5><i class="fas fa-credit-card"></i> MÉTODOS DE PAGAMENTO</h5>
                    <div class="payment-options">
                        <div class="payment-option active" data-method="mercadopago">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSIjMDBBNkZCIi8+Cjwvc3ZnPgo=" alt="Mercado Pago">
                            <span>Mercado Pago</span>
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>

                <button class="btn-checkout" onclick="processPayment()">
                    <i class="fas fa-lock"></i>
                    PAGAR COM SEGURANÇA
                    <span class="checkout-secure">Pagamento 100% Seguro</span>
                </button>

                <div class="security-badges">
                    <div class="security-badge">
                        <i class="fas fa-shield-alt"></i>
                        <span>SSL Seguro</span>
                    </div>
                    <div class="security-badge">
                        <i class="fas fa-lock"></i>
                        <span>Dados Protegidos</span>
                    </div>
                    <div class="security-badge">
                        <i class="fas fa-certificate"></i>
                        <span>Site Verificado</span>
                    </div>
                </div>
            </div>

            <div id="loadingPayment" style="display: none;">
                <div class="loading-payment">
                    <div class="loading-animation">
                        <div class="loading-circle"></div>
                        <div class="loading-circle"></div>
                        <div class="loading-circle"></div>
                    </div>
                    <h4>PROCESSANDO PAGAMENTO</h4>
                    <p>Redirecionando para o Mercado Pago...</p>
                    <div class="loading-progress">
                        <div class="progress-bar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Modal de Checkout Melhorado */
.checkout-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.checkout-modal {
    background: hsl(var(--bg-secondary));
    border: 2px solid hsl(var(--border-primary));
    border-radius: var(--radius-xl);
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.checkout-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 2rem;
    border-bottom: 2px solid hsl(var(--border-primary));
    background: linear-gradient(135deg, hsl(var(--primary) / 0.1), hsl(var(--secondary) / 0.1));
}

.checkout-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.checkout-title i {
    color: hsl(var(--primary));
    font-size: 1.5rem;
}

.checkout-title h3 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.checkout-close {
    background: none;
    border: 2px solid hsl(var(--border-primary));
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: hsl(var(--text-secondary));
    cursor: pointer;
    transition: all var(--transition-medium);
}

.checkout-close:hover {
    border-color: hsl(var(--danger));
    color: hsl(var(--danger));
    background: hsl(var(--danger) / 0.1);
}

.checkout-body {
    padding: 2rem;
}

/* Auth Prompt */
.auth-prompt {
    text-align: center;
    padding: 2rem 0;
}

.auth-icon {
    font-size: 4rem;
    color: hsl(var(--primary));
    margin-bottom: 1.5rem;
}

.auth-prompt h4 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: hsl(var(--text-primary));
}

.auth-prompt p {
    color: hsl(var(--text-secondary));
    margin-bottom: 2rem;
}

.auth-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

/* Order Card */
.order-card {
    background: hsl(var(--bg-tertiary));
    border: 1px solid hsl(var(--border-primary));
    border-radius: var(--radius-lg);
    margin-bottom: 2rem;
    overflow: hidden;
}

.order-header {
    background: linear-gradient(135deg, hsl(var(--primary) / 0.1), hsl(var(--secondary) / 0.1));
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border-bottom: 1px solid hsl(var(--border-primary));
}

.order-header i {
    color: hsl(var(--primary));
}

.order-header h4 {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.order-details {
    padding: 1.5rem;
}

.order-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.order-item.total {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 2px solid hsl(var(--border-primary));
    font-weight: 700;
    font-size: 1.1rem;
}

.item-label {
    color: hsl(var(--text-secondary));
    font-size: 0.9rem;
}

.item-value {
    color: hsl(var(--text-primary));
    font-weight: 600;
}

.item-price {
    color: hsl(var(--primary));
    font-weight: 700;
    font-size: 1.2rem;
}

.order-separator {
    height: 1px;
    background: hsl(var(--border-primary));
    margin: 1rem 0;
}

/* Payment Methods */
.payment-methods {
    margin-bottom: 2rem;
}

.payment-methods h5 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: hsl(var(--text-secondary));
}

.payment-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    border: 2px solid hsl(var(--border-primary));
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-medium);
}

.payment-option:hover {
    border-color: hsl(var(--primary));
    background: hsl(var(--primary) / 0.1);
}

.payment-option.active {
    border-color: hsl(var(--primary));
    background: hsl(var(--primary) / 0.1);
}

.payment-option img {
    width: 24px;
    height: 24px;
}

.payment-option span {
    flex: 1;
    font-weight: 600;
}

.payment-option i {
    color: hsl(var(--primary));
}

/* Checkout Button */
.btn-checkout {
    width: 100%;
    background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--secondary)));
    border: none;
    border-radius: var(--radius-lg);
    padding: 1.25rem 2rem;
    color: #000;
    font-weight: 700;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all var(--transition-medium);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    margin-bottom: 1.5rem;
    position: relative;
    overflow: hidden;
}

.btn-checkout:hover {
    transform: translateY(-2px);
    box-shadow: var(--glow);
}

.btn-checkout:active {
    transform: translateY(0);
}

.checkout-secure {
    font-size: 0.75rem;
    font-weight: 500;
    opacity: 0.8;
}

/* Security Badges */
.security-badges {
    display: flex;
    justify-content: space-around;
    gap: 1rem;
    margin-top: 1rem;
}

.security-badge {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: hsl(var(--text-muted));
}

.security-badge i {
    color: hsl(var(--success));
    font-size: 1rem;
}

/* Loading Payment */
.loading-payment {
    text-align: center;
    padding: 3rem 1rem;
}

.loading-animation {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 2rem;
}

.loading-circle {
    width: 12px;
    height: 12px;
    background: hsl(var(--primary));
    border-radius: 50%;
    animation: loadingBounce 1.4s ease-in-out infinite both;
}

.loading-circle:nth-child(1) { animation-delay: -0.32s; }
.loading-circle:nth-child(2) { animation-delay: -0.16s; }

@keyframes loadingBounce {
    0%, 80%, 100% {
        transform: scale(0);
    }
    40% {
        transform: scale(1);
    }
}

.loading-payment h4 {
    margin-bottom: 0.5rem;
    color: hsl(var(--text-primary));
}

.loading-payment p {
    color: hsl(var(--text-secondary));
    margin-bottom: 2rem;
}

.loading-progress {
    width: 100%;
    height: 4px;
    background: hsl(var(--border-primary));
    border-radius: 2px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, hsl(var(--primary)), hsl(var(--secondary)));
    animation: progressAnimation 2s ease-in-out infinite;
}

@keyframes progressAnimation {
    0% { width: 0%; }
    50% { width: 60%; }
    100% { width: 100%; }
}

/* Responsive */
@media (max-width: 640px) {
    .checkout-modal {
        margin: 1rem;
        max-width: calc(100% - 2rem);
    }
    
    .checkout-header,
    .checkout-body {
        padding: 1rem;
    }
    
    .auth-actions {
        flex-direction: column;
    }
    
    .security-badges {
        flex-direction: column;
        gap: 0.75rem;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let selectedPlanData = null;
let availableProducts = [];

function selectPlan(planType, price) {
    console.log('Selecionando plano:', planType, price);
    selectedPlanData = { type: planType, price: price };

    // Verificar se o usuário está logado
    const token = localStorage.getItem('access_token');
    console.log('Token encontrado:', !!token);

    if (!token) {
        // Se não estiver logado, redirecionar para login
        window.location.href = '/login?redirect=comprar';
        return;
    }

    // Se estiver logado, abrir modal de checkout
    openCheckoutModal(planType, price);
}

function selectProduct(productId, planType, price) {
    console.log('Selecionando produto:', productId, planType, price);
    selectedPlanData = { 
        product_id: productId,
        type: planType, 
        price: price 
    };

    // Verificar se o usuário está logado
    const token = localStorage.getItem('access_token');
    console.log('Token encontrado:', !!token);

    if (!token) {
        // Se não estiver logado, redirecionar para login
        window.location.href = '/login?redirect=comprar';
        return;
    }

    // Se estiver logado, abrir modal de checkout
    openCheckoutModal(planType, price);
}

function openCheckoutModal(planType, price) {
    const modal = document.getElementById('checkoutModal');
    const loginPrompt = document.getElementById('loginPrompt');
    const checkoutForm = document.getElementById('checkoutForm');
    const loadingPayment = document.getElementById('loadingPayment');

    // Reset modal state
    if (loadingPayment) loadingPayment.style.display = 'none';
    if (loginPrompt) loginPrompt.style.display = 'none';
    if (checkoutForm) checkoutForm.style.display = 'block';

    // Atualizar resumo
    const selectedPlanElement = document.getElementById('selectedPlan');
    const selectedPriceElement = document.getElementById('selectedPrice');
    const selectedDurationElement = document.getElementById('selectedDuration');

    if (selectedPlanElement) {
        selectedPlanElement.textContent = planType.toUpperCase();
    }
    if (selectedPriceElement) {
        selectedPriceElement.textContent = `R$ ${price.toFixed(2).replace('.', ',')}`;
    }
    if (selectedDurationElement) {
        const durations = {
            'mensal': '30 dias',
            'trimestral': '90 dias',
            'anual': '365 dias'
        };
        selectedDurationElement.textContent = durations[planType] || '30 dias';
    }

    // Abrir modal
    if (modal) {
        modal.style.display = 'flex';
        console.log('Modal aberto');
        
        // Adicionar animação
        setTimeout(() => {
            modal.classList.add('active');
        }, 10);
    } else {
        console.error('Modal não encontrado');
    }
}

function closeCheckoutModal() {
    const modal = document.getElementById('checkoutModal');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
}

async function processPayment() {
    console.log('Processando pagamento...');

    if (!selectedPlanData) {
        console.error('Nenhum plano selecionado');
        showToast('Erro: Nenhum plano selecionado', 'error');
        return;
    }

    const token = localStorage.getItem('access_token');
    if (!token) {
        console.error('Token não encontrado');
        showToast('Sessão expirada. Redirecionando para login...', 'error');
        setTimeout(() => {
            window.location.href = '/login?redirect=comprar';
        }, 2000);
        return;
    }

    console.log('Criando preferência de pagamento:', selectedPlanData);

    // Mostrar loading
    const checkoutForm = document.getElementById('checkoutForm');
    const loadingPayment = document.getElementById('loadingPayment');

    if (checkoutForm) checkoutForm.style.display = 'none';
    if (loadingPayment) loadingPayment.style.display = 'block';

    try {
        // Preparar dados da compra
        const formData = new FormData();
        
        if (selectedPlanData.product_id) {
            formData.append('product_id', selectedPlanData.product_id);
        } else {
            formData.append('plano', selectedPlanData.type);
        }

        console.log('Criando preferência de pagamento...');

        // Criar preferência de pagamento
        const response = await fetch('/api/create-payment-preference', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        console.log('Status da resposta:', response.status);

        if (response.ok) {
            const data = await response.json();
            console.log('Dados da resposta:', data);
            
            if (data.success && data.init_point) {
                showToast('Redirecionando para o pagamento...', 'success');
                
                // Fechar modal
                closeCheckoutModal();
                
                // Redirecionar para o Mercado Pago
                setTimeout(() => {
                    window.location.href = data.init_point;
                }, 1000);
            } else {
                throw new Error('Erro ao criar preferência de pagamento');
            }
        } else {
            const errorData = await response.json().catch(() => ({}));
            
            if (response.status === 401) {
                showToast('Sessão expirada. Faça login novamente.', 'error');
                localStorage.clear();
                setTimeout(() => {
                    window.location.href = '/login?redirect=comprar';
                }, 2000);
            } else {
                throw new Error(errorData.detail || `Erro ${response.status}: ${response.statusText}`);
            }
        }
    } catch (error) {
        console.error('Erro na compra:', error);
        showToast('Erro ao processar compra: ' + error.message, 'error');

        // Voltar ao formulário
        if (loadingPayment) loadingPayment.style.display = 'none';
        if (checkoutForm) checkoutForm.style.display = 'block';
    }
}

function toggleFaq(element) {
    const faqItem = element.parentElement;
    const answer = faqItem.querySelector('.faq-answer');
    const icon = element.querySelector('i');

    // Fechar outros FAQs
    document.querySelectorAll('.faq-item').forEach(item => {
        if (item !== faqItem && item.classList.contains('active')) {
            item.classList.remove('active');
            item.querySelector('.faq-answer').style.maxHeight = '0';
            item.querySelector('.faq-question i').style.transform = 'rotate(0deg)';
        }
    });

    // Toggle atual
    faqItem.classList.toggle('active');

    if (faqItem.classList.contains('active')) {
        answer.style.maxHeight = answer.scrollHeight + 'px';
        icon.style.transform = 'rotate(180deg)';
    } else {
        answer.style.maxHeight = '0';
        icon.style.transform = 'rotate(0deg)';
    }
}

// Fechar modal ao clicar fora
window.onclick = function(event) {
    const modal = document.getElementById('checkoutModal');
    if (event.target === modal) {
        closeCheckoutModal();
    }
}

async function loadProducts() {
    try {
        const response = await fetch('/api/products');
        if (response.ok) {
            const products = await response.json();
            console.log('Produtos carregados:', products);
            
            // Atualizar preços na página se houver produtos disponíveis
            if (products.length > 0) {
                updatePricingFromProducts(products);
            }
        }
    } catch (error) {
        console.error('Erro ao carregar produtos:', error);
    }
}

function updatePricingFromProducts(products) {
    availableProducts = products;
    
    // Mapear produtos por duração
    const productMap = {};
    products.forEach(product => {
        if (product.duration_days === 30) {
            productMap.mensal = product;
        } else if (product.duration_days === 90) {
            productMap.trimestral = product;
        } else if (product.duration_days === 365) {
            productMap.anual = product;
        }
    });

    // Atualizar cards com produtos do banco
    const cards = document.querySelectorAll('.pricing-card');
    cards.forEach((card, index) => {
        const planTypes = ['mensal', 'trimestral', 'anual'];
        const planType = planTypes[index];
        const product = productMap[planType];
        
        if (product) {
            // Atualizar preço
            const priceAmount = card.querySelector('.amount');
            if (priceAmount) {
                priceAmount.textContent = Math.floor(product.price);
            }
            
            // Atualizar período
            const period = card.querySelector('.period');
            if (period) {
                if (product.duration_days === 30) {
                    period.textContent = ',90/mês';
                } else if (product.duration_days === 90) {
                    period.textContent = ',90/3 meses';
                } else if (product.duration_days === 365) {
                    period.textContent = ',90/ano';
                }
            }
            
            // Atualizar recursos
            if (product.features) {
                const featuresList = card.querySelector('.pricing-features');
                if (featuresList) {
                    const features = product.features.split(',');
                    featuresList.innerHTML = features.map(feature => 
                        `<li><i class="fas fa-check"></i> ${feature.trim()}</li>`
                    ).join('');
                }
            }
            
            // Atualizar botão
            const button = card.querySelector('button');
            if (button) {
                button.setAttribute('onclick', `selectProduct(${product.id}, '${planType}', ${product.price})`);
            }
        }
    });
}

function selectProduct(productId, planType, price) {
    console.log('Selecionando produto:', productId, planType, price);
    selectedPlanData = { 
        product_id: productId,
        type: planType, 
        price: price 
    };

    // Verificar se o usuário está logado
    const token = localStorage.getItem('access_token');
    console.log('Token encontrado:', !!token);

    if (!token) {
        // Se não estiver logado, redirecionar para login
        showToast('Faça login para continuar com a compra', 'warning');
        setTimeout(() => {
            window.location.href = '/login?redirect=comprar';
        }, 1500);
        return;
    }

    // Se estiver logado, abrir modal de checkout
    openCheckoutModal(planType, price);
}

// Função para exibir toast (caso não exista)
function showToast(message, type = 'info') {
    console.log(`Toast ${type}: ${message}`);
    
    // Criar elemento toast se não existir sistema de toast
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#00ff8c' : type === 'error' ? '#ff006b' : '#007bff'};
        color: #000;
        padding: 1rem;
        border-radius: 5px;
        z-index: 10000;
        max-width: 300px;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Debug e inicialização
document.addEventListener('DOMContentLoaded', function() {
    console.log('Página de compras carregada');
    
    // Carregar produtos disponíveis
    loadProducts();

    // Verificar se elementos existem
    const modal = document.getElementById('checkoutModal');
    const loginPrompt = document.getElementById('loginPrompt');
    const checkoutForm = document.getElementById('checkoutForm');

    console.log('Modal encontrado:', !!modal);
    console.log('Login prompt encontrado:', !!loginPrompt);
    console.log('Checkout form encontrado:', !!checkoutForm);

    // Animar cards de pricing
    const cards = document.querySelectorAll('.pricing-card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.classList.add('animate-slide-up');
        }, index * 200);
    });

    // Verificar autenticação
    const token = localStorage.getItem('access_token');
    console.log('Usuário autenticado:', !!token);
    
    // Verificar se há redirecionamento de login
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('from') === 'login') {
        showToast('Login realizado com sucesso! Escolha seu plano.', 'success');
    }
});
</script>
{% endblock %}