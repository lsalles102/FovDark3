{% extends "base.html" %}

{% block content %}
<div class="pricing-container">
    <h1>Planos FovDark</h1>
    <div class="pricing-cards">
        <div class="pricing-card">
            <h2>Plano Mensal</h2>
            <div class="price">R$ 29,90</div>
            <button class="select-plan" data-plan="mensal">Selecionar</button>
        </div>
        <div class="pricing-card">
            <h2>Plano Trimestral</h2>
            <div class="price">R$ 79,90</div>
            <button class="select-plan" data-plan="trimestral">Selecionar</button>
        </div>
        <div class="pricing-card">
            <h2>Plano Anual</h2>
            <div class="price">R$ 299,90</div>
            <button class="select-plan" data-plan="anual">Selecionar</button>
        </div>
    </div>
</div>

<div id="checkoutModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Finalizar Compra</h2>
            <button class="modal-close" onclick="closeModal('checkoutModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="checkout-summary">
                <h3>Resumo do Pedido</h3>
                <div class="summary-item">
                    <span class="item-name" id="selectedPlanName">Plano Mensal</span>
                    <span class="item-price" id="selectedPlanPrice">R$ 29,90</span>
                </div>
                <div class="summary-total">
                    <span>Total:</span>
                    <span id="totalPrice">R$ 29,90</span>
                </div>
            </div>

            <form id="checkoutForm" onsubmit="processPayment(event)">
                <input type="hidden" id="selectedPlan" name="plano" value="">
                <button type="submit" class="button primary">
                    <i class="fas fa-shield-alt"></i> PROCESSAR PAGAMENTO
                </button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Verificar se está logado
    const token = localStorage.getItem('access_token');
    if (!token) {
        showToast('Você precisa fazer login primeiro', 'warning');
        setTimeout(() => {
            window.location.href = '/login';
        }, 2000);
        return;
    }

    // Event listeners para seleção de plano
    document.querySelectorAll('.select-plan').forEach(button => {
        button.addEventListener('click', function() {
            const plan = this.dataset.plan;
            openCheckoutModal(plan);
        });
    });
});

function openCheckoutModal(plan) {
    const plans = {
        mensal: { name: 'Plano Mensal', price: 'R$ 29,90' },
        trimestral: { name: 'Plano Trimestral', price: 'R$ 79,90' },
        anual: { name: 'Plano Anual', price: 'R$ 299,90' }
    };

    const selectedPlan = plans[plan];
    document.getElementById('selectedPlanName').textContent = selectedPlan.name;
    document.getElementById('selectedPlanPrice').textContent = selectedPlan.price;
    document.getElementById('totalPrice').textContent = selectedPlan.price;
    document.getElementById('selectedPlan').value = plan;
    document.getElementById('checkoutModal').style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

async function processPayment(event) {
    event.preventDefault();
    const form = document.getElementById('checkoutForm');
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    const token = localStorage.getItem('access_token');

    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PROCESSANDO...';
    submitBtn.disabled = true;

    try {
        const response = await fetch('/api/criar-checkout', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                plano: formData.get('plano')
            })
        });

        const data = await response.json();

        if (response.ok && data.id) {
            window.location.href = `https://checkout.stripe.com/pay/${data.id}`;
        } else {
            if (response.status === 401) {
                showToast('Sessão expirada. Faça login novamente.', 'error');
                localStorage.clear();
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            } else {
                showToast(data.detail || 'Erro ao processar pagamento', 'error');
            }
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao processar pagamento', 'error');
    } finally {
        submitBtn.innerHTML = '<i class="fas fa-shield-alt"></i> PROCESSAR PAGAMENTO';
        submitBtn.disabled = false;
    }
}

// Fechar modal clicando fora
window.onclick = function(e) {
    const modal = document.getElementById('checkoutModal');
    if (e.target === modal) {
        closeModal('checkoutModal');
    }
}
</script>
{% endblock %}