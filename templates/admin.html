{% extends "base.html" %}

{% block title %}Painel Administrativo - FovDark{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="dashboard-header">
        <h1><i class="fas fa-shield-alt"></i> Painel Administrativo</h1>
        <div class="admin-actions">
            <button class="btn btn-secondary" onclick="refreshDashboard()">
                <i class="fas fa-sync"></i> Atualizar
            </button>
            <button class="btn btn-primary" onclick="exportData()">
                <i class="fas fa-download"></i> Exportar
            </button>
        </div>
    </div>

    <!-- Dashboard Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3 id="totalUsers">0</h3>
                <p>Total de Usuários</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon success">
                <i class="fas fa-key"></i>
            </div>
            <div class="stat-content">
                <h3 id="activeLicenses">0</h3>
                <p>Licenças Ativas</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-content">
                <h3 id="suspiciousLogins">0</h3>
                <p>Logins Suspeitos</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon info">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
                <h3 id="recentLogins">0</h3>
                <p>Logins (24h)</p>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-container">
            <h3><i class="fas fa-chart-pie"></i> Distribuição de Licenças</h3>
            <canvas id="licenseChart"></canvas>
        </div>

        <div class="chart-container">
            <h3><i class="fas fa-chart-line"></i> Registros por Dia</h3>
            <canvas id="registrationChart"></canvas>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <h3><i class="fas fa-filter"></i> Filtros e Pesquisa</h3>
        <div class="filter-grid">
            <div class="filter-group">
                <label>Status da Licença:</label>
                <select id="statusFilter">
                    <option value="">Todos</option>
                    <option value="ativa">Ativa</option>
                    <option value="expirada">Expirada</option>
                    <option value="pendente">Pendente</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Min. Tentativas de Login:</label>
                <input type="number" id="attemptsFilter" min="0" placeholder="Ex: 3">
            </div>

            <div class="filter-group">
                <label>Filtro por IP:</label>
                <input type="text" id="ipFilter" placeholder="Ex: 192.168">
            </div>

            <div class="filter-group">
                <button class="btn btn-primary" onclick="applyFilters()">
                    <i class="fas fa-search"></i> Aplicar Filtros
                </button>
                <button class="btn btn-secondary" onclick="clearFilters()">
                    <i class="fas fa-times"></i> Limpar
                </button>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="table-section">
        <div class="table-header">
            <h3><i class="fas fa-table"></i> Usuários</h3>
            <div class="table-controls">
                <span id="userCount">0 usuários</span>
                <div class="pagination-controls">
                    <button class="btn btn-sm" onclick="previousPage()" id="prevBtn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="pageInfo">Página 1</span>
                    <button class="btn btn-sm" onclick="nextPage()" id="nextBtn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th>Status Licença</th>
                        <th>Tentativas Login</th>
                        <th>Último Login</th>
                        <th>IP Registro</th>
                        <th>IP Último Login</th>
                        <th>Admin</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Dados carregados via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Security Report Section -->
    <div class="security-section">
        <h3><i class="fas fa-shield-alt"></i> Relatório de Segurança</h3>

        <div class="security-grid">
            <div class="security-card">
                <h4><i class="fas fa-network-wired"></i> IPs Suspeitos</h4>
                <div id="suspiciousIpsList">
                    <!-- Carregado via JavaScript -->
                </div>
            </div>

            <div class="security-card">
                <h4><i class="fas fa-user-slash"></i> Usuários Inativos</h4>
                <div id="inactiveUsersList">
                    <!-- Carregado via JavaScript -->
                </div>
            </div>

            <div class="security-card">
                <h4><i class="fas fa-exclamation-circle"></i> Tentativas Falhadas</h4>
                <div id="failedAttemptsList">
                    <!-- Carregado via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let currentPage = 1;
let totalPages = 1;
let currentFilters = {};

document.addEventListener('DOMContentLoaded', function() {
    checkAdminAuth();
    loadDashboard();
    loadUsers();
    loadSecurityReport();
});

async function checkAdminAuth() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login';
        return;
    }

    try {
        const response = await fetch('/api/admin/users', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            if (response.status === 403) {
                alert('Acesso negado. Privilégios de administrador necessários.');
                window.location.href = '/painel';
            } else {
                throw new Error('Erro na autenticação');
            }
        }
    } catch (error) {
        console.error('Erro:', error);
        window.location.href = '/login';
    }
}

async function loadDashboard() {
    const token = localStorage.getItem('access_token');

    try {
        const response = await fetch('/api/admin/dashboard', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            updateDashboardStats(data);
            createCharts(data);
        }
    } catch (error) {
        console.error('Erro ao carregar dashboard:', error);
    }
}

function updateDashboardStats(data) {
    document.getElementById('totalUsers').textContent = data.general_stats.total_users;
    document.getElementById('activeLicenses').textContent = data.general_stats.active_licenses;
    document.getElementById('suspiciousLogins').textContent = data.general_stats.suspicious_logins;
    document.getElementById('recentLogins').textContent = data.general_stats.recent_logins_24h;
}

function createCharts(data) {
    // Gráfico de distribuição de licenças
    const licenseCtx = document.getElementById('licenseChart').getContext('2d');
    new Chart(licenseCtx, {
        type: 'doughnut',
        data: {
            labels: data.license_distribution.map(item => item.status),
            datasets: [{
                data: data.license_distribution.map(item => item.count),
                backgroundColor: [
                    '#00ff88',
                    '#ff6b6b', 
                    '#4ecdc4',
                    '#45b7d1',
                    '#f9ca24'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: {
                        color: '#ffffff'
                    }
                }
            }
        }
    });

    // Gráfico de registros por dia
    const registrationCtx = document.getElementById('registrationChart').getContext('2d');
    new Chart(registrationCtx, {
        type: 'line',
        data: {
            labels: data.daily_registrations.map(item => new Date(item.date).toLocaleDateString('pt-BR')),
            datasets: [{
                label: 'Registros',
                data: data.daily_registrations.map(item => item.count),
                borderColor: '#00ff88',
                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    ticks: {
                        color: '#ffffff'
                    }
                },
                x: {
                    ticks: {
                        color: '#ffffff'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#ffffff'
                    }
                }
            }
        }
    });
}

async function loadUsers() {
    const token = localStorage.getItem('access_token');
    const offset = (currentPage - 1) * 50;

    // Construir URL com filtros
    const params = new URLSearchParams({
        limit: 50,
        offset: offset,
        ...currentFilters
    });

    try {
        const response = await fetch(`/api/admin/users?${params}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            displayUsers(data.users);
            updatePagination(data.total, data.offset, data.limit);
        }
    } catch (error) {
        console.error('Erro ao carregar usuários:', error);
    }
}

function displayUsers(users) {
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';

    users.forEach(user => {
        const row = document.createElement('tr');

        const statusClass = getStatusClass(user.status_licenca);
        const adminBadge = user.is_admin ? '<span class="admin-badge">ADMIN</span>' : '';
        const lastLogin = user.ultimo_login ? 
            new Date(user.ultimo_login).toLocaleString('pt-BR') : 
            'Nunca';

        row.innerHTML = `
            <td>${user.id}</td>
            <td>${user.email}</td>
            <td><span class="status-badge ${statusClass}">${user.status_licenca}</span></td>
            <td>${user.tentativas_login}</td>
            <td>${lastLogin}</td>
            <td>${user.ip_registro || 'N/A'}</td>
            <td>${user.ip_ultimo_login || 'N/A'}</td>
            <td>${adminBadge}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="viewUserDetails(${user.id})">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-warning" onclick="editUser(${user.id})">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        `;

        tbody.appendChild(row);
    });
}

function getStatusClass(status) {
    switch(status) {
        case 'ativa': return 'status-active';
        case 'expirada': return 'status-expired';
        case 'pendente': return 'status-pending';
        default: return 'status-unknown';
    }
}

function updatePagination(total, offset, limit) {
    totalPages = Math.ceil(total / limit);
    currentPage = Math.floor(offset / limit) + 1;

    document.getElementById('userCount').textContent = `${total} usuários`;
    document.getElementById('pageInfo').textContent = `Página ${currentPage} de ${totalPages}`;

    document.getElementById('prevBtn').disabled = currentPage <= 1;
    document.getElementById('nextBtn').disabled = currentPage >= totalPages;
}

function applyFilters() {
    currentFilters = {};

    const statusFilter = document.getElementById('statusFilter').value;
    const attemptsFilter = document.getElementById('attemptsFilter').value;
    const ipFilter = document.getElementById('ipFilter').value;

    if (statusFilter) currentFilters.status_licenca = statusFilter;
    if (attemptsFilter) currentFilters.min_tentativas = attemptsFilter;
    if (ipFilter) currentFilters.ip_filter = ipFilter;

    currentPage = 1;
    loadUsers();
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('attemptsFilter').value = '';
    document.getElementById('ipFilter').value = '';

    currentFilters = {};
    currentPage = 1;
    loadUsers();
}

function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        loadUsers();
    }
}

function nextPage() {
    if (currentPage < totalPages) {
        currentPage++;
        loadUsers();
    }
}

async function loadSecurityReport() {
    const token = localStorage.getItem('access_token');

    try {
        const response = await fetch('/api/admin/security-report', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            displaySecurityReport(data);
        }
    } catch (error) {
        console.error('Erro ao carregar relatório de segurança:', error);
    }
}

function displaySecurityReport(data) {
    // IPs suspeitos
    const suspiciousIpsList = document.getElementById('suspiciousIpsList');
    suspiciousIpsList.innerHTML = data.suspicious_ips.map(item => 
        `<div class="security-item">
            <span class="ip">${item.ip}</span>
            <span class="count">${item.user_count} usuários</span>
        </div>`
    ).join('');

    // Usuários inativos
    const inactiveUsersList = document.getElementById('inactiveUsersList');
    inactiveUsersList.innerHTML = `<div class="security-metric">${data.inactive_users_count} usuários inativos</div>`;
}

function refreshDashboard() {
    loadDashboard();
    loadUsers();
    loadSecurityReport();
}

function exportData() {
    // Implementar exportação de dados
    alert('Funcionalidade de exportação em desenvolvimento');
}

function viewUserDetails(userId) {
    // Implementar visualização de detalhes do usuário
    alert(`Visualizar detalhes do usuário ${userId}`);
}

function editUser(userId) {
    // Implementar edição de usuário
    alert(`Editar usuário ${userId}`);
}
</script>

<style>
.admin-dashboard {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.dashboard-header h1 {
    font-size: 2.5rem;
    background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--secondary)));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.admin-actions {
    display: flex;
    gap: 1rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: hsl(var(--bg-glass));
    backdrop-filter: blur(10px);
    border: 2px solid hsl(var(--border-primary));
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--secondary)));
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
}

.stat-icon.success {
    background: linear-gradient(135deg, hsl(var(--success)), #00cc66);
}

.stat-icon.warning {
    background: linear-gradient(135deg, hsl(var(--warning)), #ff9900);
}

.stat-icon.info {
    background: linear-gradient(135deg, hsl(var(--accent)), #0099ff);
}

.stat-content h3 {
    font-size: 2rem;
    margin: 0;
    color: hsl(var(--text-primary));
}

.stat-content p {
    margin: 0.5rem 0 0 0;
    color: hsl(var(--text-secondary));
}

.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.chart-container {
    background: hsl(var(--bg-glass));
    backdrop-filter: blur(10px);
    border: 2px solid hsl(var(--border-primary));
    border-radius: var(--radius-lg);
    padding: 1.5rem;
}

.chart-container h3 {
    margin-bottom: 1rem;
    color: hsl(var(--text-primary));
}

.filters-section {
    background: hsl(var(--bg-glass));
    backdrop-filter: blur(10px);
    border: 2px solid hsl(var(--border-primary));
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.filter-group label {
    color: hsl(var(--text-secondary));
    font-weight: 500;
}

.filter-group input,
.filter-group select {
    padding: 0.5rem;
    border: 1px solid hsl(var(--border-primary));
    border-radius: var(--radius-md);
    background: hsl(var(--bg-secondary));
    color: hsl(var(--text-primary));
}

.table-section {
    background: hsl(var(--bg-glass));
    backdrop-filter: blur(10px);
    border: 2px solid hsl(var(--border-primary));
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.table-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.pagination-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.table-container {
    overflow-x: auto;
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
}

.admin-table th,
.admin-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid hsl(var(--border-primary));
}

.admin-table th {
    background: hsl(var(--bg-tertiary));
    color: hsl(var(--text-primary));
    font-weight: 600;
}

.admin-table td {
    color: hsl(var(--text-secondary));
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-active {
    background: hsl(var(--success) / 0.2);
    color: hsl(var(--success));
}

.status-expired {
    background: hsl(var(--danger) / 0.2);
    color: hsl(var(--danger));
}

.status-pending {
    background: hsl(var(--warning) / 0.2);
    color: hsl(var(--warning));
}

.admin-badge {
    background: hsl(var(--secondary));
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
}

.security-section {
    background: hsl(var(--bg-glass));
    backdrop-filter: blur(10px);
    border: 2px solid hsl(var(--border-primary));
    border-radius: var(--radius-lg);
    padding: 1.5rem;
}

.security-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}

.security-card {
    background: hsl(var(--bg-secondary));
    border: 1px solid hsl(var(--border-primary));
    border-radius: var(--radius-md);
    padding: 1rem;
}

.security-card h4 {
    margin-bottom: 1rem;
    color: hsl(var(--text-primary));
}

.security-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid hsl(var(--border-primary));
}

.security-item:last-child {
    border-bottom: none;
}

.security-metric {
    font-size: 1.25rem;
    font-weight: 600;
    color: hsl(var(--text-primary));
    text-align: center;
    padding: 1rem;
}

@media (max-width: 768px) {
    .dashboard-header {
        flex-direction: column;
        gap: 1rem;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .charts-section {
        grid-template-columns: 1fr;
    }

    .filter-grid {
        grid-template-columns: 1fr;
    }

    .table-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }

    .security-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}