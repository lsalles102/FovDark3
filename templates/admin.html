{% extends "base.html" %}

{% block title %}Painel Administrativo - DarkFov{% endblock %}

{% block content %}
<section class="admin-section">
    <div class="container">
        <!-- Admin Header -->
        <div class="admin-header">
            <h1>PAINEL ADMINISTRATIVO</h1>
            <p>Controle total do sistema DarkFov</p>
        </div>
        
        <!-- Admin Navigation -->
        <div class="admin-nav">
            <button class="admin-nav-btn active" data-tab="overview">
                <i class="fas fa-chart-pie"></i>
                VISÃO GERAL
            </button>
            <button class="admin-nav-btn" data-tab="users">
                <i class="fas fa-users"></i>
                USUÁRIOS
            </button>
            <button class="admin-nav-btn" data-tab="products">
                <i class="fas fa-box"></i>
                PRODUTOS
            </button>
            <button class="admin-nav-btn" data-tab="payments">
                <i class="fas fa-credit-card"></i>
                PAGAMENTOS
            </button>
            <button class="admin-nav-btn" data-tab="system">
                <i class="fas fa-cogs"></i>
                SISTEMA
            </button>
        </div>
        
        <!-- Overview Tab -->
        <div id="overview-tab" class="admin-tab active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalUsers">-</h3>
                        <span>Total de Usuários</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="activeLicenses">-</h3>
                        <span>Licenças Ativas</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalRevenue">R$ -</h3>
                        <span>Receita Total</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="todaySignups">-</h3>
                        <span>Cadastros Hoje</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Products Tab -->
        <div id="products-tab" class="admin-tab">
            <div class="tab-header">
                <h2>GERENCIAR PRODUTOS</h2>
                <div class="tab-actions">
                    <button class="btn btn-primary" onclick="openProductModal()">
                        <i class="fas fa-plus"></i>
                        NOVO PRODUTO
                    </button>
                    <button class="btn btn-secondary" onclick="refreshProducts()">
                        <i class="fas fa-sync-alt"></i>
                        ATUALIZAR
                    </button>
                </div>
            </div>
            
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Preço</th>
                            <th>Duração</th>
                            <th>Status</th>
                            <th>Destaque</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr>
                            <td colspan="7" class="loading-row">
                                <i class="fas fa-spinner fa-spin"></i>
                                Carregando produtos...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="admin-tab">
            <div class="tab-header">
                <h2>GERENCIAR USUÁRIOS</h2>
                <button class="btn btn-primary" onclick="refreshUsers()">
                    <i class="fas fa-sync-alt"></i>
                    ATUALIZAR
                </button>
            </div>
            
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Tipo</th>
                            <th>Licença</th>
                            <th>Cadastro</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="6" class="loading-row">
                                <i class="fas fa-spinner fa-spin"></i>
                                Carregando usuários...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Payments Tab -->
        <div id="payments-tab" class="admin-tab">
            <div class="tab-header">
                <h2>HISTÓRICO DE PAGAMENTOS</h2>
                <button class="btn btn-primary" onclick="refreshPayments()">
                    <i class="fas fa-sync-alt"></i>
                    ATUALIZAR
                </button>
            </div>
            
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usuário</th>
                            <th>Valor</th>
                            <th>Data</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody">
                        <tr>
                            <td colspan="5" class="loading-row">
                                <i class="fas fa-spinner fa-spin"></i>
                                Carregando pagamentos...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- System Tab -->
        <div id="system-tab" class="admin-tab">
            <div class="tab-header">
                <h2>CONFIGURAÇÕES DO SISTEMA</h2>
            </div>
            
            <div class="system-controls">
                <div class="control-group">
                    <h3>Manutenção</h3>
                    <div class="control-items">
                        <button class="btn btn-outline" onclick="clearCache()">
                            <i class="fas fa-broom"></i>
                            LIMPAR CACHE
                        </button>
                        <button class="btn btn-outline" onclick="exportData()">
                            <i class="fas fa-download"></i>
                            EXPORTAR DADOS
                        </button>
                        <button class="btn btn-warning" onclick="maintenanceMode()">
                            <i class="fas fa-tools"></i>
                            MODO MANUTENÇÃO
                        </button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>Logs do Sistema</h3>
                    <div class="log-viewer">
                        <pre id="systemLogs">Sistema iniciado com sucesso
Conexão com banco estabelecida
Todos os serviços online
Anti-detecção ativo</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Product Modal -->
<div id="productModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="productModalTitle">NOVO PRODUTO</h2>
            <button class="modal-close" onclick="closeModal('productModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="productForm">
                <input type="hidden" id="productId" name="product_id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="productName">Nome do Produto:</label>
                        <input type="text" id="productName" name="name" required placeholder="Ex: DarkFov Premium">
                    </div>
                    
                    <div class="form-group">
                        <label for="productPrice">Preço (R$):</label>
                        <input type="number" id="productPrice" name="price" step="0.01" min="0" required placeholder="29.90">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="productDuration">Duração (dias):</label>
                        <input type="number" id="productDuration" name="duration_days" min="1" required placeholder="30">
                    </div>
                    
                    <div class="form-group">
                        <label for="productImage">URL da Imagem:</label>
                        <input type="url" id="productImage" name="image_url" placeholder="https://exemplo.com/imagem.jpg">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="productDescription">Descrição:</label>
                    <textarea id="productDescription" name="description" rows="3" placeholder="Descrição detalhada do produto..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="productFeatures">Recursos (um por linha):</label>
                    <textarea id="productFeatures" name="features" rows="5" placeholder="Aimbot inteligente&#10;ESP & Wallhack&#10;Anti-detecção&#10;Suporte 24/7"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="productActive" name="is_active" checked>
                            <span class="checkmark"></span>
                            Produto ativo
                        </label>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="productFeatured" name="is_featured">
                            <span class="checkmark"></span>
                            Produto em destaque
                        </label>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('productModal')">
                        CANCELAR
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        SALVAR PRODUTO
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- User Edit Modal -->
<div id="userEditModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>EDITAR USUÁRIO</h2>
            <button class="modal-close" onclick="closeModal('userEditModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="userEditForm">
                <input type="hidden" id="editUserId" name="user_id">
                
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="editUserEmail" readonly>
                </div>
                
                <div class="form-group">
                    <label>Estender Licença (dias):</label>
                    <input type="number" id="extendDays" name="dias" min="0" max="365" placeholder="0 = remover licença">
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userEditModal')">
                        CANCELAR
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        SALVAR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    checkAdminAuth();
    setupAdminNavigation();
    loadOverviewData();
});

function checkAdminAuth() {
    const token = localStorage.getItem('access_token');
    const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
    
    if (!token || !userData.is_admin) {
        showToast('Acesso negado. Privilégios de administrador necessários.', 'error');
        setTimeout(() => {
            window.location.href = '/';
        }, 2000);
        return;
    }
}

function setupAdminNavigation() {
    document.querySelectorAll('.admin-nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            switchAdminTab(tabName);
        });
    });
}

function switchAdminTab(tabName) {
    // Remover classe active de todos os botões e tabs
    document.querySelectorAll('.admin-nav-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
    
    // Adicionar classe active ao botão e tab selecionados
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}-tab`).classList.add('active');
    
    // Carregar dados específicos da tab
    switch(tabName) {
        case 'users':
            loadUsers();
            break;
        case 'products':
            loadProducts();
            break;
        case 'payments':
            loadPayments();
            break;
        case 'overview':
            loadOverviewData();
            break;
    }
}

async function loadOverviewData() {
    // Em uma implementação real, estes dados viriam da API
    // Aqui vamos simular alguns dados
    document.getElementById('totalUsers').textContent = '1,234';
    document.getElementById('activeLicenses').textContent = '892';
    document.getElementById('totalRevenue').textContent = 'R$ 45,678';
    document.getElementById('todaySignups').textContent = '15';
}

async function loadUsers() {
    const token = localStorage.getItem('access_token');
    const tbody = document.getElementById('usersTableBody');
    
    try {
        const response = await fetch('/api/admin/users', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const users = await response.json();
            displayUsers(users);
        } else {
            throw new Error('Erro ao carregar usuários');
        }
        
    } catch (error) {
        console.error('Erro:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="error-row">
                    <i class="fas fa-exclamation-triangle"></i>
                    Erro ao carregar usuários
                </td>
            </tr>
        `;
    }
}

function displayUsers(users) {
    const tbody = document.getElementById('usersTableBody');
    
    if (users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="empty-row">
                    <i class="fas fa-users"></i>
                    Nenhum usuário encontrado
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = users.map(user => {
        const licenseStatus = user.data_expiracao ? 
            (new Date(user.data_expiracao) > new Date() ? 'Ativa' : 'Expirada') : 
            'Sem licença';
        
        const userType = user.is_admin ? 'Admin' : 'Usuário';
        const cadastroDate = user.created_at ? 
            new Date(user.created_at).toLocaleDateString('pt-BR') : 
            '-';
        
        return `
            <tr>
                <td>${user.id}</td>
                <td>${user.email}</td>
                <td>
                    <span class="badge ${user.is_admin ? 'badge-admin' : 'badge-user'}">
                        ${userType}
                    </span>
                </td>
                <td>
                    <span class="badge ${licenseStatus === 'Ativa' ? 'badge-success' : licenseStatus === 'Expirada' ? 'badge-warning' : 'badge-danger'}">
                        ${licenseStatus}
                    </span>
                </td>
                <td>${cadastroDate}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-icon btn-edit" onclick="editUser(${user.id}, '${user.email}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${!user.is_admin ? `
                            <button class="btn-icon btn-delete" onclick="deleteUser(${user.id})" title="Deletar">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

async function loadPayments() {
    const token = localStorage.getItem('access_token');
    const tbody = document.getElementById('paymentsTableBody');
    
    try {
        const response = await fetch('/api/admin/payments', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const payments = await response.json();
            displayPayments(payments);
        } else {
            throw new Error('Erro ao carregar pagamentos');
        }
        
    } catch (error) {
        console.error('Erro:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="error-row">
                    <i class="fas fa-exclamation-triangle"></i>
                    Erro ao carregar pagamentos
                </td>
            </tr>
        `;
    }
}

function displayPayments(payments) {
    const tbody = document.getElementById('paymentsTableBody');
    
    if (payments.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="empty-row">
                    <i class="fas fa-credit-card"></i>
                    Nenhum pagamento encontrado
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = payments.map(payment => {
        const dataFormatada = new Date(payment.data_pagamento).toLocaleDateString('pt-BR');
        const valorFormatado = `R$ ${payment.valor.toFixed(2)}`;
        
        return `
            <tr>
                <td>${payment.id}</td>
                <td>Usuário #${payment.user_id}</td>
                <td>${valorFormatado}</td>
                <td>${dataFormatada}</td>
                <td>
                    <span class="badge badge-success">
                        ${payment.status}
                    </span>
                </td>
            </tr>
        `;
    }).join('');
}

function editUser(userId, userEmail) {
    document.getElementById('editUserId').value = userId;
    document.getElementById('editUserEmail').value = userEmail;
    document.getElementById('extendDays').value = '';
    
    document.getElementById('userEditModal').style.display = 'flex';
}

async function deleteUser(userId) {
    if (!confirm('Tem certeza que deseja deletar este usuário?')) {
        return;
    }
    
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            showToast('Usuário deletado com sucesso', 'success');
            loadUsers(); // Recarregar lista
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erro ao deletar usuário', 'error');
        }
        
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro de conexão', 'error');
    }
}

// Event listener para o formulário de edição
document.getElementById('userEditForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const userId = formData.get('user_id');
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch(`/api/admin/users/${userId}/license`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        if (response.ok) {
            showToast('Usuário atualizado com sucesso', 'success');
            closeModal('userEditModal');
            loadUsers(); // Recarregar lista
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erro ao atualizar usuário', 'error');
        }
        
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro de conexão', 'error');
    }
});

function refreshUsers() {
    loadUsers();
}

function refreshPayments() {
    loadPayments();
}

function clearCache() {
    showToast('Cache limpo com sucesso', 'success');
}

function exportData() {
    showToast('Exportação iniciada', 'info');
}

function maintenanceMode() {
    if (confirm('Ativar modo de manutenção? Isso impedirá novos logins.')) {
        showToast('Modo de manutenção ativado', 'warning');
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Funções para gerenciar produtos
async function loadProducts() {
    const token = localStorage.getItem('access_token');
    const tbody = document.getElementById('productsTableBody');
    
    try {
        const response = await fetch('/api/admin/products', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const products = await response.json();
            displayProducts(products);
        } else {
            throw new Error('Erro ao carregar produtos');
        }
        
    } catch (error) {
        console.error('Erro:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="error-row">
                    <i class="fas fa-exclamation-triangle"></i>
                    Erro ao carregar produtos
                </td>
            </tr>
        `;
    }
}

function displayProducts(products) {
    const tbody = document.getElementById('productsTableBody');
    
    if (products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="empty-row">
                    <i class="fas fa-box"></i>
                    Nenhum produto encontrado
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = products.map(product => {
        const statusBadge = product.is_active ? 
            '<span class="badge badge-success">Ativo</span>' : 
            '<span class="badge badge-danger">Inativo</span>';
        
        const featuredBadge = product.is_featured ? 
            '<span class="badge badge-warning">Sim</span>' : 
            '<span class="badge badge-secondary">Não</span>';
        
        const priceFormatted = `R$ ${product.price.toFixed(2)}`;
        const durationText = `${product.duration_days} dias`;
        
        return `
            <tr>
                <td>${product.id}</td>
                <td>${product.name}</td>
                <td>${priceFormatted}</td>
                <td>${durationText}</td>
                <td>${statusBadge}</td>
                <td>${featuredBadge}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-icon btn-edit" onclick="editProduct(${product.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon ${product.is_active ? 'btn-warning' : 'btn-success'}" 
                                onclick="toggleProductStatus(${product.id}, ${!product.is_active})" 
                                title="${product.is_active ? 'Pausar' : 'Ativar'}">
                            <i class="fas ${product.is_active ? 'fa-pause' : 'fa-play'}"></i>
                        </button>
                        <button class="btn-icon btn-delete" onclick="deleteProduct(${product.id})" title="Deletar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function openProductModal(productId = null) {
    const modal = document.getElementById('productModal');
    const title = document.getElementById('productModalTitle');
    const form = document.getElementById('productForm');
    
    if (productId) {
        title.textContent = 'EDITAR PRODUTO';
        loadProductData(productId);
    } else {
        title.textContent = 'NOVO PRODUTO';
        form.reset();
        document.getElementById('productId').value = '';
        document.getElementById('productActive').checked = true;
    }
    
    modal.style.display = 'flex';
}

async function loadProductData(productId) {
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch('/api/admin/products', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const products = await response.json();
            const product = products.find(p => p.id === productId);
            
            if (product) {
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productDuration').value = product.duration_days;
                document.getElementById('productImage').value = product.image_url || '';
                document.getElementById('productFeatures').value = product.features || '';
                document.getElementById('productActive').checked = product.is_active;
                document.getElementById('productFeatured').checked = product.is_featured;
            }
        }
    } catch (error) {
        console.error('Erro ao carregar dados do produto:', error);
        showToast('Erro ao carregar dados do produto', 'error');
    }
}

async function editProduct(productId) {
    openProductModal(productId);
}

async function toggleProductStatus(productId, newStatus) {
    const token = localStorage.getItem('access_token');
    
    try {
        // Primeiro buscar os dados atuais do produto
        const getResponse = await fetch('/api/admin/products', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!getResponse.ok) {
            throw new Error('Erro ao buscar dados do produto');
        }
        
        const products = await getResponse.json();
        const product = products.find(p => p.id === productId);
        
        if (!product) {
            throw new Error('Produto não encontrado');
        }
        
        // Criar FormData com todos os dados necessários
        const formData = new FormData();
        formData.append('name', product.name);
        formData.append('description', product.description || '');
        formData.append('price', product.price);
        formData.append('duration_days', product.duration_days);
        formData.append('image_url', product.image_url || '');
        formData.append('features', product.features || '');
        formData.append('is_active', newStatus);
        formData.append('is_featured', product.is_featured);
        
        const response = await fetch(`/api/admin/products/${productId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        if (response.ok) {
            showToast(`Produto ${newStatus ? 'ativado' : 'pausado'} com sucesso`, 'success');
            loadProducts();
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erro ao alterar status do produto', 'error');
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao alterar status do produto', 'error');
    }
}

async function deleteProduct(productId) {
    if (!confirm('Tem certeza que deseja deletar este produto?')) {
        return;
    }
    
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch(`/api/admin/products/${productId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            showToast('Produto deletado com sucesso', 'success');
            loadProducts();
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erro ao deletar produto', 'error');
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao deletar produto', 'error');
    }
}

function refreshProducts() {
    loadProducts();
}

// Event listener para o formulário de produtos
document.addEventListener('DOMContentLoaded', function() {
    const productForm = document.getElementById('productForm');
    if (productForm) {
        productForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            await saveProduct();
        });
    }
});

async function saveProduct() {
    const form = document.getElementById('productForm');
    const formData = new FormData(form);
    const token = localStorage.getItem('access_token');
    const productId = document.getElementById('productId').value;
    
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
    submitBtn.disabled = true;
    
    try {
        const url = productId ? `/api/admin/products/${productId}` : '/api/admin/products';
        const method = productId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        if (response.ok) {
            const action = productId ? 'atualizado' : 'criado';
            showToast(`Produto ${action} com sucesso`, 'success');
            closeModal('productModal');
            loadProducts();
        } else {
            const data = await response.json();
            showToast(data.detail || 'Erro ao salvar produto', 'error');
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao salvar produto', 'error');
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

// Fechar modal clicando fora
window.addEventListener('click', function(e) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
