{% extends "base.html" %} {% block title %}Login - FovDark{% endblock %} {%
block content %}
<section class="auth-section">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-icon">
                    <i class="fas fa-user"></i>
                </div>
                <h1>FAZER LOGIN</h1>
                <p>Entre com sua conta para acessar o FovDark</p>
            </div>

            <form id="loginForm" class="auth-form" novalidate>
                <div class="form-group">
                    <label for="email">
                        <i class="fas fa-envelope"></i>
                        EMAIL
                    </label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        autocomplete="email"
                        placeholder="seuemail@exemplo.com"
                    />
                    <div class="input-error" id="email-error"></div>
                </div>

                <div class="form-group">
                    <label for="password">
                        <i class="fas fa-lock"></i>
                        SENHA
                    </label>
                    <div class="password-input">
                        <input
                            type="password"
                            id="password"
                            name="password"
                            required
                            autocomplete="current-password"
                            placeholder="Sua senha secreta"
                        />
                        <button
                            type="button"
                            class="password-toggle"
                            onclick="togglePassword('password')"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="input-error" id="password-error"></div>
                </div>

                <button
                    type="submit"
                    class="btn btn-primary btn-full"
                    id="login-btn"
                >
                    <i class="fas fa-sign-in-alt"></i>
                    <span>INICIAR SESS√ÉO</span>
                </button>
            </form>

            <div class="auth-footer">
                <p>N√£o possui uma conta?</p>
                <a href="/register" class="auth-link">
                    <i class="fas fa-user-plus"></i>
                    CRIAR CONTA
                </a>
            </div>
        </div>

        <div class="auth-visual">
            <div class="terminal-window">
                <div class="terminal-header">
                    <div class="terminal-buttons">
                        <span class="btn-close"></span>
                        <span class="btn-minimize"></span>
                        <span class="btn-maximize"></span>
                    </div>
                    <span class="terminal-title">FovDark Terminal</span>
                </div>
                <div class="terminal-body">
                    <div class="terminal-line">
                        <span class="prompt">root@fovdark:~$</span>
                        <span class="command">./authenticate.sh</span>
                    </div>
                    <div class="terminal-line">
                        <span class="output"
                            >Initializing security protocols...</span
                        >
                    </div>
                    <div class="terminal-line">
                        <span class="output success"
                            >‚úì Anti-detection systems online</span
                        >
                    </div>
                    <div class="terminal-line">
                        <span class="output success"
                            >‚úì Encryption modules loaded</span
                        >
                    </div>
                    <div class="terminal-line">
                        <span class="output warning"
                            >‚ö† Awaiting user authentication</span
                        >
                    </div>
                    <div class="terminal-line terminal-cursor">
                        <span class="prompt">root@darkfov:~$</span>
                        <span class="cursor">_</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %} {% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Verificar se j√° est√° logado com token v√°lido
        const token = localStorage.getItem("access_token");
        if (token) {
            // Usar endpoint de verifica√ß√£o de licen√ßa que √© mais confi√°vel
            fetch("/api/license/check", {
                headers: { Authorization: `Bearer ${token}` },
            })
                .then((response) => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 401) {
                        console.log("‚ùå Token expirado, limpando localStorage");
                        localStorage.clear();
                        return null;
                    }
                    throw new Error(`HTTP ${response.status}`);
                })
                .then((data) => {
                    if (data) {
                        console.log("üîç Token v√°lido, verificando usu√°rio:", data);

                        if (data.is_admin === true) {
                            console.log("üëë Redirecionando admin para /admin");
                            window.location.href = "/admin";
                        } else {
                            console.log("üë§ Redirecionando usu√°rio para /painel");
                            window.location.href = "/painel";
                        }
                    }
                })
                .catch((error) => {
                    console.log("‚ùå Erro na verifica√ß√£o do token:", error);
                    // N√£o limpar localStorage em caso de erro de rede
                });
            return;
        }

        const loginForm = document.getElementById("loginForm");
        if (loginForm) {
            loginForm.addEventListener("submit", login);
        }

        // Listeners para tecla Enter
        const emailField = document.getElementById("email");
        const passwordField = document.getElementById("password");

        if (emailField && passwordField) {
            emailField.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    passwordField.focus();
                }
            });

            passwordField.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    login(e);
                }
            });
        }
    });

    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const toggle = field.parentElement.querySelector(".password-toggle i");

        if (field && toggle) {
            if (field.type === "password") {
                field.type = "text";
                toggle.className = "fas fa-eye-slash";
            } else {
                field.type = "password";
                toggle.className = "fas fa-eye";
            }
        }
    }
</script>
{% endblock %}
